<!DOCTYPE html>
<html lang=en>

<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description"
        content="Phần 3Final thoughtsĐây là lần thứ hai mình tham gia, và là lần đầu tiên mình giải được đủ các challenge của Flare-on CTF, nên cảm thấy rất vui. Vui vì cuối cùng">
    <meta property="og:type" content="article">
    <meta property="og:title" content="FLAREON 2020 - WRITEUP PHẦN 3">
    <meta property="og:url" content="https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/index.html">
    <meta property="og:site_name" content="&#x2F; home &#x2F; cyberjutsu &#x2F; blog &#x2F;">
    <meta property="og:description"
        content="Phần 3Final thoughtsĐây là lần thứ hai mình tham gia, và là lần đầu tiên mình giải được đủ các challenge của Flare-on CTF, nên cảm thấy rất vui. Vui vì cuối cùng">
    <meta property="og:locale" content="en_US">
    <meta property="article:published_time" content="2021-01-05T17:00:01.000Z">
    <meta property="article:modified_time" content="2021-06-04T02:28:06.726Z">
    <meta property="article:author" content="CyberJutsu Team">
    <meta property="article:tag" content="flareon">
    <meta property="article:tag" content="reverse engineering">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:image" content="https://blog.cyberjutsu.io/images/flareon/part3.jpg">
    <meta property="og:image" content="https://blog.cyberjutsu.io/images/flareon/part3.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">




    <link rel="shortcut icon" href="/images/favicon.ico">




    <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">




    <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">



    <!-- title -->
    <title>FLAREON 2020 - WRITEUP PHẦN 3</title>
    <!-- styles -->

    <link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    <!-- fix bug: by bach' -->
    <!-- 
      
<link rel="stylesheet" href="/css/rtl.css">

     -->
    <!-- rss -->


    <meta name="generator" content="Hexo 5.2.0">
</head>

<body class="max-width mx-auto ltr">

    <div id="header-post">
        <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
        <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
        <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"
            style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
        <span id="menu">
            <span id="nav">
                <ul>

                    <li><a href="/home.html">home</a></li>

                    <li><a href="/about/about.html">about</a></li>

                    <li><a href="/archives/archives.html">articles</a></li>

                    <li><a target="_blank" rel="noopener" href="https://cyberjutsu.io/publications/">publications</a>
                    </li>

                </ul>
            </span>
            <br />
            <span id="actions">
                <ul>

                    <li><a class="icon" href="/2021/05/13/HTML-sanitizer-vs-XSS/"><i class="fas fa-chevron-left"
                                aria-hidden="true" onmouseover="$('#i-prev').toggle();"
                                onmouseout="$('#i-prev').toggle();"></i></a></li>


                    <li><a class="icon" href="/2020/12/24/flareon-phan-2.html"><i class="fas fa-chevron-right"
                                aria-hidden="true" onmouseover="$('#i-next').toggle();"
                                onmouseout="$('#i-next').toggle();"></i></a></li>

                    <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i
                                class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();"
                                onmouseout="$('#i-top').toggle();"></i></a></li>
                    <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true"
                                onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();"
                                onclick="$('#share').toggle();return false;"></i></a></li>
                </ul>
                <span id="i-prev" class="info" style="display:none;">Previous post</span>
                <span id="i-next" class="info" style="display:none;">Next post</span>
                <span id="i-top" class="info" style="display:none;">Back to top</span>
                <span id="i-share" class="info" style="display:none;">Share post</span>
            </span>
            <br />
            <div id="share" style="display: none">
                <ul>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://www.facebook.com/sharer.php?u=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/"><i
                                class="fab fa-facebook " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="https://twitter.com/share?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&text=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-twitter " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://www.linkedin.com/shareArticle?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-linkedin " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&is_video=false&description=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-pinterest " aria-hidden="true"></i></a></li>
                    <li><a class="icon"
                            href="mailto:?subject=FLAREON 2020 - WRITEUP PHẦN 3&body=Check out this article: https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/"><i
                                class="fas fa-envelope " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="https://getpocket.com/save?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://reddit.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-reddit " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://www.stumbleupon.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://digg.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-digg " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="http://www.tumblr.com/share/link?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&name=FLAREON 2020 - WRITEUP PHẦN 3&description="><i
                                class="fab fa-tumblr " aria-hidden="true"></i></a></li>
                    <li><a class="icon" target="_blank" rel="noopener"
                            href="https://news.ycombinator.com/submitlink?u=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&t=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
                </ul>

            </div>
            <div id="toc">
                <ol class="toc">
                    <li class="toc-item toc-level-2"><a class="toc-link" href="#Phan-3"><span
                                class="toc-number">1.</span> <span class="toc-text">Phần 3</span></a>
                        <ol class="toc-child">
                            <li class="toc-item toc-level-3"><a class="toc-link" href="#Final-thoughts"><span
                                        class="toc-number">1.1.</span> <span class="toc-text">Final thoughts</span></a>
                            </li>
                        </ol>
                    </li>
                </ol>
                </li>
                <li class="toc-item toc-level-1"><a class="toc-link" href="#9-crackinstaller"><span
                            class="toc-number"></span> <span class="toc-text">9 - crackinstaller</span></a></li>
                <li class="toc-item toc-level-1"><a class="toc-link" href="#10-break"><span class="toc-number"></span>
                        <span class="toc-text">10 - break</span></a></li>
                <li class="toc-item toc-level-1"><a class="toc-link" href="#11-rabbithole"><span
                            class="toc-number"></span> <span class="toc-text">11 - rabbithole</span></a></li>
                <li class="toc-item toc-level-1"><a class="toc-link" href="#Procmon-to-the-rescue"><span
                            class="toc-number"></span> <span class="toc-text">Procmon to the rescue</span></a>
            </div>
        </span>
    </div>


    <div class="content index py4">

        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header>

                <h1 class="posttitle" itemprop="name headline">
                    FLAREON 2020 - WRITEUP PHẦN 3
                </h1>



                <div class="meta">
                    <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
                        <span itemprop="name">xikhud</span>
                    </span>>>

                    <div class="postdate">

                        <time datetime="2021-01-05T17:00:01.000Z" itemprop="datePublished">2021-01-06</time>


                    </div>





                    <div class="article-tag">
                        <i class="fas fa-tag"></i>
                        <a class="tag-link-link" href="/tags/flareon/" rel="tag">flareon</a>, <a class="tag-link-link"
                            href="/tags/reverse-engineering/" rel="tag">reverse engineering</a>
                    </div>


                </div>
            </header>


            <div class="content" itemprop="articleBody">
                <main>
                    <div class="c-glitch" style="background-image: url('/images/flareon/part3.jpg');">
                        <img src='/images/flareon/part3.jpg' />
                        <div class="c-glitch__img" style="background-image: url('/images/flareon/part3.jpg');"></div>
                        <div class="c-glitch__img" style="background-image: url('/images/flareon/part3.jpg');"></div>
                        <div class="c-glitch__img" style="background-image: url('/images/flareon/part3.jpg');"></div>
                        <div class="c-glitch__img" style="background-image: url('/images/flareon/part3.jpg');"></div>
                        <div class="c-glitch__img" style="background-image: url('/images/flareon/part3.jpg');"></div>
                    </div>
                </main>

                <h2 id="Phan-3"><a href="#Phan-3" class="headerlink" title="Phần 3">Phần 3</a></h2>
                <h3 id="Final-thoughts"><a href="#Final-thoughts" class="headerlink" title="Final thoughts">Final
                        thoughts</a></h3>
                <p>Đây là lần thứ hai mình tham gia, và là lần đầu tiên mình giải được đủ các challenge của
                    <code>Flare-on CTF</code>, nên cảm thấy rất vui. Vui vì cuối cùng mình cũng có được cái huy hiệu của
                    <code>Flare-on</code>, nhưng quan trọng hơn cả là mình cảm thấy trong một năm qua, mình đã tiến bộ
                    hơn nhiều.
                </p>
                <p>Sau hơn một tháng ngồi làm các challenge này, mình có một số cảm nhận, cũng như một số mẹo nhỏ cho
                    bạn đọc:</p>
                <ul>
                    <li>Cấu trúc file <code>PE</code> là kiến thức mà mọi người chơi Reverse Engineer và Malware Analyst
                        nên học. Ví dụ như ở bài 2 và bài 11, mình đã vận dụng kiến thức về file <code>PE</code> để có
                        thể sửa lại file bị corrupt.</li>
                    <li><code>Reflective DLL Injection</code>, cũng giống như trên, là một kỹ thuật được dùng nhiều
                        trong malware, vì nó khó bị detect hơn so với các phương thức inject khác, kỹ thuật này được sử
                        dụng ở bài 9, và bài 11.</li>
                    <li><code>windbg</code> là một debugger rất mạnh, có thể script nữa. Thật sự mà nói, trong khoảng
                        thời gian chơi RE gần 2 năm, mình chưa bao giờ dùng <code>windbg</code>, mình toàn coi tutorial
                        <code>RE</code> của anh <code>kienmanowar</code> rồi dùng <code>x64dbg</code> vì nó có giao diện
                        đẹp, bấm chuột click click, dễ xài hơn. Ở bài 9, mình phải tập sử dụng <code>windbg</code> để
                        debug window kernel và lấy <code>password</code> (đây cũng là lần đầu tiên mình debug windows
                        kernel).
                    </li>
                    <li>Khi làm các công việc lặp đi lặp lại nhiều lần, hãy viết <code>script</code> nếu có thể. Mình đã
                        viết <code>script</code> cho <code>windbg</code>, <code>gdb</code> ở bài 11, bài 9 và bài 10,
                        giúp tiết kiệm rất nhiều thời gian.</li>
                    <li><code>&quot;Khi bạn đã nhìn vào một thứ quá lâu mà vẫn không thấy gì, hãy lùi lại một bước để nhìn nó ở một góc độ khác&quot;</code>
                        - anh <code>Mạnh Luật (l4w)</code> said. Điều này mình thấy rất đúng. Mình đã dùng tới tận 12
                        ngày để giải bài cuối cùng, nhưng trong đó, 11 ngày đầu, mình chỉ ngồi <code>RE</code> một đống
                        <code>DLL</code>. Nhận thấy cách làm này không ổn, mình đã chuyển sang góc nhìn khác
                        :arrow_right: dùng <code>procmon</code> để quan sát mọi thứ. Và, … mình chỉ tốn chưa tới 12
                        tiếng để tìm ra flag cho bài cuối ! (Nếu dùng <code>wireshark</code> bạn đọc cũng sẽ thấy được
                        program làm gì đó, từ đó trace ngược lại và tìm ra flag).
                    </li>
                    <li>Khi gặp source code bị <code>obfuscate</code>, hãy cố gắng tìm các pattern trong code, và dùng
                        <code>regex</code> để <code>rename</code> các biến, các hàm … thay vì dùng
                        <code>find and replace</code> (bài 6).
                    </li>
                    <li>Monitor các hàm <code>API</code> để hiểu được flow program cũng là một cách hay, mình đã dùng
                        cách này ở bài 7, và bài 10.</li>
                    <li>Khi <code>RE</code> các hàm lớn, có thể nhìn <code>input</code> và <code>output</code> để đoán
                        xem hàm đó là gì.</li>
                    <li>Khi <code>RE</code> các hàm có rất nhiều phép <code>xor, rotate, shift</code>, khả năng cao đó
                        là hàm của một thuật toán <code>crypto</code> hoặc hàm <code>hash</code> nào đó. Dùng plugin
                        <code>findcrypt</code> trong IDA hoặc google các hằng số tìm thấy trong program để biết được hàm
                        đó là gì.
                    </li>
                </ul>
                <p>Cuối cùng, xin cảm ơn <code>Fireeye</code> đã tổ chức một kỳ CTF rất chất lượng cho những người chơi
                    <code>Reverse Engineer</code> ! Đồng thời mình cũng cảm ơn tất cả các bạn đọc đã bỏ ra thời gian quý
                    giá để đọc tới đây, hi vọng mọi người sẽ thích bài này và ủng hộ các bài blog mà mình sẽ viết trong
                    thời gian tiếp theo ^^!
                </p>
                <p>–Trung–</p>
                <p>Cùng đến với phần cuối cùng của hành trình bằng 3 thử thách:</p>
                <ul>
                    <li><code>crackinstaller</code> (<a href="/static/flareon2020/solution9.zip">solution</a>)</li>
                    <li><code>break</code> (<a href="/static/flareon2020/solution10.zip">solution</a>)</li>
                    <li><code>rabbithole</code> (<a href="/static/flareon2020/solution11.zip">solution</a>)</li>
                </ul>
                <h1 id="9-crackinstaller"><a href="#9-crackinstaller" class="headerlink" title="9 - crackinstaller">9 -
                        crackinstaller</a></h1>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">What kind of crackme doesn&#39;t even ask for the password? We need to work on our COMmunication skills.</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p><img src="/images/flareon/9/1.png"></p>
                <p>Ở bài này, chúng ta lại có 1 file .exe. Ta mở file lên trong IDA, nhảy thẳng tới hàm main, hàm này
                    khá đơn giản, chỉ làm nhiệm vụ drop 1 file dll ra
                    “C:\Users&lt;name&gt;\AppData\Local\Microsoft\Credentials\credHelper.dll”, sau đó load dll này và
                    gọi hàm <code>DllRegisterServer</code>.</p>
                <p><img src="/images/flareon/9/2.png"></p>
                <p>Vậy là file này khá đơn giản, giờ ta chuyển sang phân tích hàm <code>DllRegisterServer</code> của
                    credHelper.dll</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">HRESULT __stdcall <span class="title">DllRegisterServer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  mb_memset((__int64)Filename, <span class="number">0</span>, <span class="number">0x200</span>ui64);</span><br><span class="line">  mb_memset((__int64)sz, <span class="number">0</span>, <span class="number">0x102</span>ui64);</span><br><span class="line">  mb_memset((__int64)&amp;v16, <span class="number">0</span>, <span class="number">0x1F2</span>ui64);</span><br><span class="line">  v8 = <span class="number">0x720065</span>;</span><br><span class="line">  *(_OWORD *)credHelperUString = xmmword_180017790;<span class="comment">// = UNICODE &quot;CredHelper&quot;</span></span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v11 = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">  *(_OWORD *)apartmentUString = xmmword_1800177A8;<span class="comment">// = UNICODE &quot;Apartment&quot;</span></span><br><span class="line">  v18 = <span class="number">0</span>;</span><br><span class="line">  GetModuleFileNameW(hModule, (LPWSTR)Filename, <span class="number">0xFF</span>u);</span><br><span class="line">  v0 = <span class="number">-1</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v0;</span><br><span class="line">  <span class="keyword">while</span> ( Filename[v0] );                       <span class="comment">// v0 = lstrlenW(FileName)</span></span><br><span class="line">  v1 = <span class="number">2</span> * v0 + <span class="number">2</span>;</span><br><span class="line">  StringFromGUID2(&amp;rguid, (LPOLESTR)sz, <span class="number">129</span>);</span><br><span class="line">  v2 = &amp;sz[<span class="number">135</span>];</span><br><span class="line">  v14 = &#x27;\\\0D&#x27;;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  *(_QWORD *)SubKey = <span class="number">20548029787144259</span>i64;     <span class="comment">// UNICODE: &#x27;CLSID\&#x27;</span></span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    ++v2;</span><br><span class="line">  <span class="keyword">while</span> ( *v2 );                                <span class="comment">// v2 = endof(SubKey)</span></span><br><span class="line">  v3 = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = sz[v3];</span><br><span class="line">    v2[v3++] = v4;                              <span class="comment">// SubKey = SubKey + sz</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  v5 = RegCreateKeyExW(HKEY_CLASSES_ROOT, SubKey, <span class="number">0</span>, <span class="number">0</span>i64, <span class="number">0</span>, KEY_ALL_ACCESS, <span class="number">0</span>i64, &amp;hKey, <span class="number">0</span>i64);</span><br><span class="line">  <span class="keyword">if</span> ( v5</span><br><span class="line">    || (v5 = RegSetValueExW(hKey, <span class="number">0</span>i64, <span class="number">0</span>, REG_SZ, credHelperUString, <span class="number">22u</span>)) != <span class="number">0</span></span><br><span class="line">    || (v5 = RegCreateKeyExW(hKey, <span class="string">L&quot;InProcServer32&quot;</span>, <span class="number">0</span>, <span class="number">0</span>i64, <span class="number">0</span>, KEY_ALL_ACCESS, <span class="number">0</span>i64, &amp;hSubKeyInProcServer32, <span class="number">0</span>i64)) != <span class="number">0</span></span><br><span class="line">    || (v5 = RegCreateKeyExW(hKey, <span class="string">L&quot;Config&quot;</span>, <span class="number">0</span>, <span class="number">0</span>i64, <span class="number">0</span>, KEY_ALL_ACCESS, <span class="number">0</span>i64, &amp;hSubKeyConfig, <span class="number">0</span>i64)) != <span class="number">0</span></span><br><span class="line">    || (v5 = RegSetValueExW(hSubKeyInProcServer32, <span class="number">0</span>i64, <span class="number">0</span>, REG_SZ, (<span class="keyword">const</span> BYTE *)Filename, v1)) != <span class="number">0</span></span><br><span class="line">    || (v5 = RegSetValueExW(hSubKeyInProcServer32, <span class="string">L&quot;ThreadingModel&quot;</span>, <span class="number">0</span>, REG_SZ, apartmentUString, <span class="number">20u</span>)) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="keyword">unsigned</span> __int16)v5 | <span class="number">0x80070000</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = v5;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    RegSetValueExW(hSubKeyConfig, <span class="string">L&quot;Password&quot;</span>, <span class="number">0</span>, REG_SZ, (<span class="keyword">const</span> BYTE *)&amp;v18, <span class="number">2u</span>);</span><br><span class="line">    RegSetValueExW(hSubKeyConfig, <span class="string">L&quot;Flag&quot;</span>, <span class="number">0</span>, REG_SZ, (<span class="keyword">const</span> BYTE *)&amp;v18, <span class="number">2u</span>);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn code trên thêm vào registry 2 key sau:</p>
                <ul>
                    <li>HKEY_CLASSES_ROOT\CLSID{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\InProcServer32</li>
                    <li>HKEY_CLASSES_ROOT\CLSID{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\Config</li>
                </ul>
                <p><img src="/images/flareon/9/3.png"></p>
                <p><img src="/images/flareon/9/4.png"></p>
                <p>Ở đây ta thấy 1 entry có name là “Flag”, có thể đó chính là flag cần tìm.</p>
                <p>Ta thử vào string windows trong IDA, dùng xref lên chuỗi “Flag” để xem có hàm nào sử dụng chuỗi này
                    nữa không, thì thấy có hàm ở 0x1800016D8:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_1800016D8</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int8 *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v2 = a2;</span><br><span class="line">  v3 = <span class="number">-2147467259</span>;</span><br><span class="line">  mb_memset(&amp;SubKey, <span class="number">0</span>i64, <span class="number">512</span>i64);</span><br><span class="line">  mb_memset(&amp;sz, <span class="number">0</span>i64, <span class="number">258</span>i64);</span><br><span class="line">  v14 = <span class="number">0</span>i64;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v16 = <span class="number">0</span>;</span><br><span class="line">  *(_OWORD *)Source = <span class="number">0</span>i64;</span><br><span class="line">  v13 = <span class="number">0</span>i64;</span><br><span class="line">  mb_memset(Data, <span class="number">0</span>i64, <span class="number">180</span>i64);</span><br><span class="line">  v4 = *v2;</span><br><span class="line">  v5 = <span class="number">0</span>i64;</span><br><span class="line">  v6 = v2[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v7 = v2[++v4 + <span class="number">2</span>];</span><br><span class="line">    v6 += v7;</span><br><span class="line">    v8 = v2[v6 + <span class="number">2</span>];</span><br><span class="line">    v2[v4 + <span class="number">2</span>] = v8;</span><br><span class="line">    v2[v6 + <span class="number">2</span>] = v7;</span><br><span class="line">    Source[v5] = byte_18001A9F0[v5] ^ v2[(<span class="keyword">unsigned</span> __int8)(v7 + v8) + <span class="number">2</span>];</span><br><span class="line">    ++v5;</span><br><span class="line">  &#125; <span class="comment">// &lt;---------------------------- RC4 here</span></span><br><span class="line">  <span class="keyword">while</span> ( v5 &lt; <span class="number">44</span> );</span><br><span class="line">  *v2 = v4;</span><br><span class="line">  v2[<span class="number">1</span>] = v6;</span><br><span class="line">  v9 = mbstowcs(Data, Source, <span class="number">0x2D</span>ui64);</span><br><span class="line">  v10 = v9;</span><br><span class="line">  <span class="keyword">if</span> ( v9 == <span class="number">-1</span> || v9 == <span class="number">45</span> )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  StringFromGUID2(&amp;rguid, &amp;sz, <span class="number">129</span>);</span><br><span class="line">  wsprintfW(&amp;SubKey, <span class="string">L&quot;%s\\%s\\%s&quot;</span>, <span class="string">L&quot;CLSID&quot;</span>, &amp;sz, <span class="string">L&quot;Config&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( RegOpenKeyExW(HKEY_CLASSES_ROOT, &amp;SubKey, <span class="number">0</span>, <span class="number">0x20006</span>u, &amp;hKey) )</span><br><span class="line">    <span class="keyword">return</span> v3;</span><br><span class="line">  RegSetValueExW(hKey, <span class="string">L&quot;Flag&quot;</span>, <span class="number">0</span>, <span class="number">1u</span>, (<span class="keyword">const</span> BYTE *)Data, <span class="number">2</span> * v10);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở đây, ta lại thêm 1 lần thấy RC4. Hàm này nhận vào 2 tham số, trong đó <code>a2</code> là con trỏ
                    tới RC4 state đã được khởi tạo từ trước.</p>
                <p>Ở hàm này ta không thấy pattern <code>for (i = 0; i &lt; 256; ++i) a[i] = i</code> , nên khả năng cao
                    trong dll này có 1 hàm khác dùng để khởi tạo state RC4.</p>
                <p>Và chính xác là như vậy, nếu ta dùng xref để xem hàm nào reference tới string “Password”, ta sẽ tới
                    được hàm ở 0x18000153C.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_18000153C</span><span class="params">(__int64 a1, _WORD *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v2 = a2;</span><br><span class="line">  mb_memset(&amp;pvData, <span class="number">0</span>i64, <span class="number">1040</span>i64);</span><br><span class="line">  mb_memset(&amp;SubKey, <span class="number">0</span>i64, <span class="number">512</span>i64);</span><br><span class="line">  mb_memset(&amp;sz, <span class="number">0</span>i64, <span class="number">258</span>i64);</span><br><span class="line">  StringFromGUID2(&amp;rguid, &amp;sz, <span class="number">129</span>);</span><br><span class="line">  wsprintfW(&amp;SubKey, <span class="string">L&quot;%s\\%s\\%s&quot;</span>, <span class="string">L&quot;CLSID&quot;</span>, &amp;sz, <span class="string">L&quot;Config&quot;</span>);</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( RegGetValueW(HKEY_CLASSES_ROOT, &amp;SubKey, <span class="string">L&quot;Password&quot;</span>, <span class="number">2u</span>, <span class="number">0</span>i64, &amp;pvData, &amp;pcbData)</span><br><span class="line">    || pcbData &lt;= <span class="number">2</span></span><br><span class="line">    || (v4 = sub_180005A2C(v20, &amp;pvData, <span class="number">260</span>i64), v4 == <span class="number">260</span>)</span><br><span class="line">    || v4 == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="number">0x80004005</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = (__int64)(v2 + <span class="number">1</span>);</span><br><span class="line">    *v2 = <span class="number">0</span>;</span><br><span class="line">    v6 = v2 + <span class="number">1</span>;</span><br><span class="line">    LOBYTE(v7) = <span class="number">0</span>;</span><br><span class="line">    v8 = <span class="number">0</span>;</span><br><span class="line">    v9 = <span class="number">0</span>;</span><br><span class="line">    v10 = <span class="number">256</span>i64;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      *v6++ = v9++;</span><br><span class="line">    <span class="keyword">while</span> ( v9 &lt; <span class="number">256</span> );</span><br><span class="line">    v11 = v4;</span><br><span class="line">    v12 = <span class="number">0</span>i64;</span><br><span class="line">    v13 = (<span class="keyword">char</span> *)v5;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v14 = *v13;</span><br><span class="line">      v15 = v12 + <span class="number">1</span>;</span><br><span class="line">      v16 = v20[v12];</span><br><span class="line">      v12 = <span class="number">0</span>i64;</span><br><span class="line">      v7 = (<span class="keyword">unsigned</span> __int8)(v7 + *v13 + v16);</span><br><span class="line">      *v13++ = *(_BYTE *)(v7 + v5);</span><br><span class="line">      *(_BYTE *)(v7 + v5) = v14;</span><br><span class="line">      v17 = v8 + <span class="number">1</span>;</span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v15 &lt; v11 )</span><br><span class="line">        v8 = v17;</span><br><span class="line">      <span class="keyword">if</span> ( v15 &lt; v11 )</span><br><span class="line">        v12 = v15;</span><br><span class="line">      --v10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v10 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm ở trên sẽ lấy data trong registry key “Password”, biến đổi nó trước khi dùng để làm RC4 key. Ở
                    trên ta có thể thấy pattern <code>&quot;do *v6++ = v9++; while (v9 &lt; 256);&quot;</code>.</p>
                <p>Vậy là ta đã biết cách để lấy được Flag, nhưng … không có Password.</p>
                <p>Mình đã ngồi phân tích file credHelper.dll rất lâu nhưng không thấy chỗ nào tạo Password, đến đây
                    mình quay lại xem file crackinstaller.exe để xem lại thì phát hiện ra mình đã bỏ sót các hàm
                    Constructor.</p>
                <blockquote>
                    <p>Constructor là các hàm được gọi trước cả hàm main. Ví dụ, cho đoạn code sau:</p>
                    <figure class="highlight c++">
                        <table>
                            <tr>
                                <td class="gutter">
                                    <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                                </td>
                                <td class="code">
                                    <pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span> &#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  Test() &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Hello world from test\n&quot;</span>);</span><br><span class="line">  &#125;  </span><br><span class="line">&#125;;</span><br><span class="line">Test test;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre>
                                </td>
                            </tr>
                        </table>
                    </figure>

                    <p>Và output của chương trình trên là:</p>
                    <figure class="highlight plain">
                        <table>
                            <tr>
                                <td class="gutter">
                                    <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                                </td>
                                <td class="code">
                                    <pre><span class="line">Hello world from test</span><br><span class="line">Hello world</span><br></pre>
                                </td>
                            </tr>
                        </table>
                    </figure>

                    <p>Đó là một trong những trường hợp mà tồn tại hàm được gọi trước hàm <code>main</code>.</p>
                </blockquote>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.rdata:000000014000F2B8 dq offset ?pre_cpp_initialization@@YAXXZ ; pre_cpp_initialization(void)</span><br><span class="line">.rdata:000000014000F2C0 dq offset sub_140001000</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta có thể thấy ở phần section .rdata có chứa địa chỉ các hàm Constructor, ta bắt đầu phân tích hàm
                    <code>sub_140001000</code>.
                </p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.text:0000000140001000 sub_140001000   proc near               ; DATA XREF: .rdata:000000014000F2C0↓o</span><br><span class="line">.text:0000000140001000                 jmp     sub_140002530</span><br><span class="line">.text:0000000140001000 sub_140001000   endp</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này lại gọi hàm <code>sub_140002530</code>, ta tiếp tục follow hàm này:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 <span class="title">sub_140002530</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v0 = <span class="number">-1</span>i64;</span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  hObjectRecv = (HANDLE)<span class="number">-1</span>i64;</span><br><span class="line">  pedata2 = <span class="number">0</span>i64;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)resolveDIAT_140001CD8() ) <span class="comment">// &lt;--- resolve IAT dynamically</span></span><br><span class="line">  &#123;</span><br><span class="line">    pedata1 = decrypt_data(&amp;data, <span class="number">8069u</span>i64, <span class="number">0x2950</span>ui64);</span><br><span class="line">    <span class="keyword">if</span> ( pedata1 )</span><br><span class="line">    &#123;</span><br><span class="line">      pedata2 = (IMAGE_DOS_HEADER *)decrypt_data(&amp;byte_140034080, <span class="number">8882u</span>i64, <span class="number">0x5800</span>ui64);</span><br><span class="line">      <span class="keyword">if</span> ( pedata2 )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = dec_unicode_string((__int64)&amp;unk_140019988, <span class="number">0x1C</span>u, <span class="number">0</span>);<span class="comment">// C:\Windows\System32\cfs.dll</span></span><br><span class="line">        v1 = writeFileByMapping_140002ED8(v4, (__int64)pedata1);<span class="comment">// cfs.dll</span></span><br><span class="line">        <span class="keyword">if</span> ( v1 )</span><br><span class="line">        &#123;</span><br><span class="line">          pCfsString = *(_QWORD *)dec_unicode_string((__int64)&amp;unk_140019900, <span class="number">4u</span>, <span class="number">0</span>);<span class="comment">// cfs</span></span><br><span class="line">          v5 = dec_unicode_string((__int64)&amp;unk_140019988, <span class="number">0x1C</span>u, <span class="number">0</span>);<span class="comment">// C:\Windows\System32\cfs.dll</span></span><br><span class="line">          *(_OWORD *)pFileName = *(_OWORD *)v5;</span><br><span class="line">          *(_OWORD *)&amp;pFileName[<span class="number">8</span>] = *((_OWORD *)v5 + <span class="number">1</span>);</span><br><span class="line">          *(_OWORD *)&amp;pFileName[<span class="number">16</span>] = *((_OWORD *)v5 + <span class="number">2</span>);</span><br><span class="line">          *(_QWORD *)&amp;pFileName[<span class="number">24</span>] = *((_QWORD *)v5 + <span class="number">6</span>);</span><br><span class="line">          v6 = dec_unicode_string((__int64)&amp;unk_1400199C0, <span class="number">0xF</span>u, <span class="number">0</span>);<span class="comment">// \\.\Htsysm72FB</span></span><br><span class="line">          *(_OWORD *)pPathSmth = *(_OWORD *)v6;</span><br><span class="line">          *(_QWORD *)&amp;pPathSmth[<span class="number">8</span>] = *((_QWORD *)v6 + <span class="number">2</span>);</span><br><span class="line">          *(_DWORD *)&amp;pPathSmth[<span class="number">12</span>] = *((_DWORD *)v6 + <span class="number">6</span>);</span><br><span class="line">          v14 = v6[<span class="number">14</span>];</span><br><span class="line">          v7 = service_140001FB4((__int64)&amp;pCfsString, (__int64)pFileName, (__int64)pPathSmth, (__int64 *)&amp;hObjectRecv);<span class="comment">// setup service</span></span><br><span class="line">          v0 = (__int64)hObjectRecv;</span><br><span class="line">          v1 = v7;</span><br><span class="line">          <span class="keyword">if</span> ( v7 )</span><br><span class="line">          &#123;</span><br><span class="line">            LODWORD(pCfsString) = <span class="number">0</span>;</span><br><span class="line">            *(_QWORD *)&amp;pFileName[<span class="number">8</span>] = <span class="number">0</span>i64;</span><br><span class="line">            *(_OWORD *)pFileName = <span class="number">0</span>i64;</span><br><span class="line">            *(_DWORD *)&amp;pFileName[<span class="number">12</span>] = <span class="number">0</span>;</span><br><span class="line">            *(_QWORD *)pPathSmth = <span class="number">0</span>i64;</span><br><span class="line">            *(_DWORD *)&amp;pPathSmth[<span class="number">4</span>] = <span class="number">0</span>;</span><br><span class="line">            pPathSmth[<span class="number">6</span>] = <span class="number">0</span>;</span><br><span class="line">            LOBYTE(pPathSmth[<span class="number">7</span>]) = <span class="number">0</span>;</span><br><span class="line">            v1 = sendDeviceIO_140002C44(hObjectRecv, pedata2);</span><br><span class="line">            <span class="keyword">if</span> ( v1 )</span><br><span class="line">            &#123;</span><br><span class="line">              v8 = dec_unicode_string((__int64)&amp;unk_140019900, <span class="number">4u</span>, <span class="number">0</span>);<span class="comment">// cfs</span></span><br><span class="line">              v1 = (<span class="keyword">unsigned</span> __int64)sub_140001EB4((__int64)v8) != <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">	<span class="comment">// ... truncated</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này đầu tiên sẽ lấy địa chỉ các hàm windows API bằng <code>LoadLibrary, GetProcAddress</code>.
                </p>
                <p>Tiếp theo, nó decrypt 1 file PE, rồi drop ra đường dẫn “C:\Windows\System32\cfs.dll” (file này thật
                    ra là file driver).</p>
                <p>Sau đó, nó load driver mới drop ra trong hàm ở 0x140001FB4, đồng thời gọi <code>CreateFile</code> để
                    tạo 1 device object.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">service_140001FB4</span><span class="params">(__int64 a1, __int64 a2, __int64 pPathSth, __int64 *phObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     <span class="comment">// truncated ...</span></span><br><span class="line">    <span class="comment">// a1 = &amp;L&quot;\\.\Htsysm72FB&quot;;</span></span><br><span class="line">  v10 = pOpenSCManagerW(<span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0xF003F</span>i64);</span><br><span class="line">  v11 = v10;</span><br><span class="line">  <span class="keyword">if</span> ( v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    v12 = pOpenServiceW(v10, pServiceName, <span class="number">0xF01FF</span>i64);</span><br><span class="line">    v13 = v12;</span><br><span class="line">    <span class="keyword">if</span> ( v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      pDeleteService(v12);</span><br><span class="line">      pCloseServiceHandle(v13);</span><br><span class="line">    &#125;</span><br><span class="line">    v14 = pCreateServiceW(v11, pServiceName, pServiceName, <span class="number">0xF01FF</span>i64, <span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>, pFileName, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64);</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      pCloseServiceHandle(v14);</span><br><span class="line">    &#125;</span><br><span class="line">    v15 = pOpenServiceW(v11, pServiceName, <span class="number">0xF01FF</span>i64);</span><br><span class="line">    v16 = v15;</span><br><span class="line">    <span class="keyword">if</span> ( v15 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> <span class="keyword">int</span>)pStartServiceW(v15, <span class="number">0</span>i64, <span class="number">0</span>i64) )</span><br><span class="line">      &#123;</span><br><span class="line">        GetLastError();</span><br><span class="line">      &#125;</span><br><span class="line">      pCloseServiceHandle(v16);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( _phObject )</span><br><span class="line">    &#123;</span><br><span class="line">      v17 = pCreateFileW(_pPathSmt, <span class="number">0xC0000000</span>i64, <span class="number">0</span>i64, <span class="number">0</span>i64, <span class="number">3</span>, <span class="number">128</span>, <span class="number">0</span>i64);</span><br><span class="line">      *_phObject = v17;</span><br><span class="line">      LOBYTE(v4) = v17 != <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pCloseServiceHandle(v11);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Cuối cùng nó decrypt 1 file PE thứ 2, copy một vài “hằng số” vào buffer tạo bởi
                    <code>VirtualAlloc</code> rồi gửi control code 0xAA013044 đến driver vừa load.
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">if</span> ( v23 )</span><br><span class="line">&#123;</span><br><span class="line">  unk_14003634B = v23;</span><br><span class="line">  unk_14003633B = pDos; <span class="comment">// &lt;---- pointer to second PE file</span></span><br><span class="line">  unk_140036345 = <span class="number">0x5800</span>;</span><br><span class="line">  v24 = (<span class="keyword">char</span> *)VirtualAlloc(<span class="number">0</span>i64, <span class="number">45u</span>i64, <span class="number">0x3000</span>u, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( v24 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_QWORD *)v24 = v24 + <span class="number">8</span>;</span><br><span class="line">    *(_OWORD *)(v24 + <span class="number">8</span>) = unk_140036338;</span><br><span class="line">    *(_OWORD *)(v24 + <span class="number">0x18</span>) = unk_140036348;</span><br><span class="line">    *((_DWORD *)v24 + <span class="number">0xA</span>) = unk_140036358;</span><br><span class="line">    v24[<span class="number">44</span>] = unk_14003635C;</span><br><span class="line">    InBuffer = v24 + <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">if</span> ( DeviceIoControl(v4, <span class="number">0xAA013044</span>, &amp;InBuffer, <span class="number">8u</span>, &amp;OutBuffer, <span class="number">4u</span>, &amp;BytesReturned, <span class="number">0</span>i64) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="comment">// ... truncated</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Giờ ta phân tích file “cfs.dll”, ta dùng PE-Bear để xem tổng quát về file này:</p>
                <p><img src="/images/flareon/9/5.png"></p>
                <p>Thử tìm thông tin về hash MD5 của file này:</p>
                <p><img src="/images/flareon/9/6.png"></p>
                <p>Ta tìm được thông tin đây là file driver đã bị <a target="_blank" rel="noopener"
                        href="https://www.fuzzysecurity.com/tutorials/28.html">exploit</a> từ năm 2016.</p>
                <p><img src="/images/flareon/9/7.png"></p>
                <p>Theo như trong <a target="_blank" rel="noopener"
                        href="https://www.youtube.com/watch?v=pJZjWXxUEl4&ab_channel=OJReeves">video này</a> thì các
                    “hằng số” ở trên kia chính là kernel shellcode. Bây giờ ta sẽ setup (kernel) debug để xem đoạn
                    shellcode trên làm gì.</p>
                <p><a target="_blank" rel="noopener"
                        href="https://voidsec.com/windows-kernel-debugging-exploitation/">Cách setup window kernel
                        debugging</a>.</p>
                <p>Đầu tiên ta dùng lệnh <code>lm</code> để liệt kê các module được load:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">start             end                 module name</span><br><span class="line">00000000&#96;77640000 00000000&#96;7773a000   USER32     (deferred)             </span><br><span class="line">00000000&#96;77740000 00000000&#96;7785f000   kernel32   (deferred)             </span><br><span class="line">00000000&#96;77860000 00000000&#96;77a09000   ntdll      (export symbols)       C:\Windows\SYSTEM32\ntdll.dll</span><br><span class="line">00000001&#96;3fd30000 00000001&#96;3fd6d000   image00000001_3fd30000   (deferred)             </span><br><span class="line">000007fe&#96;fd860000 000007fe&#96;fd8cb000   KERNELBASE   (deferred)             </span><br><span class="line">000007fe&#96;fdb80000 000007fe&#96;fdbe7000   GDI32      (deferred)             </span><br><span class="line">...</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Như trên thì crackinstaller được load tại 0x00000013fd30000, ta vào IDA lấy offset:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.text:0000000140002E1A    call    cs:DeviceIoControl</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <blockquote>
                    <p>Trong lúc viết bài này, mình có tắt windbg và bật lại nhiều lần nên Imagebase có thể thay đổi,
                        tuy nhiên offset thì không ! </p>
                </blockquote>
                <p>Imagebase là 0x140000000 nên offset sẽ là 0x2E1A. Ta gõ “bp 000000013fd30000+0x2E1A” để đặt
                    breakpoint ngay tại đây, sau đó dùng lệnh g để tiếp tục chương trình, lúc này @rip đang ở ngay tại
                    0x00000013fd32e1a. Ta gõ “u poi(@r8)” để disassemble đoạn shellcode này.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">0:000&gt; u poi(@r8)</span><br><span class="line">00000000&#96;00070008 fb              sti</span><br><span class="line">00000000&#96;00070009 48ba20920c0000000000 mov rdx,0C9220h</span><br><span class="line">00000000&#96;00070013 41b800580000    mov     r8d,5800h</span><br><span class="line">00000000&#96;00070019 41b970310000    mov     r9d,3170h</span><br><span class="line">00000000&#96;0007001f ff2500000000    jmp     qword ptr [00000000&#96;00070025]</span><br><span class="line">00000000&#96;00070025 102a            adc     byte ptr [rdx],ch</span><br><span class="line">00000000&#96;00070027 d33f            sar     dword ptr [rdi],cl</span><br><span class="line">00000000&#96;00070029 0100            add     dword ptr [rax],eax</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ngoài ra, ở dòng code thứ 2 (0x70009) ta còn thấy được con trỏ tới file PE thứ 2, và size của nó là
                    0x5800.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">0:000&gt; db 0C9220</span><br><span class="line">00000000&#96;000c9220  4d 5a 90 00 03 00 00 00-04 00 00 00 ff ff 00 00  MZ..............</span><br><span class="line">00000000&#96;000c9230  b8 00 00 00 00 00 00 00-40 00 00 00 00 00 00 00  ........@.......</span><br><span class="line">00000000&#96;000c9240  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00  ................</span><br><span class="line">00000000&#96;000c9250  00 00 00 00 00 00 00 00-00 00 00 00 e0 00 00 00  ................</span><br><span class="line">00000000&#96;000c9260  0e 1f ba 0e 00 b4 09 cd-21 b8 01 4c cd 21 54 68  ........!..L.!Th</span><br><span class="line">00000000&#96;000c9270  69 73 20 70 72 6f 67 72-61 6d 20 63 61 6e 6e 6f  is program canno</span><br><span class="line">00000000&#96;000c9280  74 20 62 65 20 72 75 6e-20 69 6e 20 44 4f 53 20  t be run in DOS </span><br><span class="line">00000000&#96;000c9290  6d 6f 64 65 2e 0d 0d 0a-24 00 00 00 00 00 00 00  mode....$.......</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta dump file này ra bằng lệnh: “.writemem C:/path/to/file.bin 0C9220 L5800”.</p>
                <p>Tiếp theo ta sẽ breakpoint ngay tại chỗ này trong cfs.dll:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_10524</span><span class="params">(<span class="keyword">void</span> (__fastcall *a1)(_QWORD))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// [rsp+20h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall *v3)(PVOID (__stdcall *)(PUNICODE_STRING)); <span class="comment">// [rsp+28h] [rbp-20h]</span></span><br><span class="line">  PVOID (__stdcall *v4)(PUNICODE_STRING); <span class="comment">// [rsp+30h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *((<span class="keyword">void</span> (__fastcall **)(_QWORD))a1 - <span class="number">1</span>) != a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>i64;</span><br><span class="line">  v3 = (<span class="keyword">void</span> (__fastcall *)(PVOID (__stdcall *)(PUNICODE_STRING)))a1;</span><br><span class="line">  v4 = MmGetSystemRoutineAddress;</span><br><span class="line">  v2 = <span class="number">0</span>i64;</span><br><span class="line">  enable((<span class="keyword">unsigned</span> __int64 *)&amp;v2);</span><br><span class="line">  v3(v4);                                       <span class="comment">// &lt;--- breakpoint here, offset 0x573</span></span><br><span class="line">  disable((<span class="keyword">unsigned</span> __int64 *)&amp;v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>i64;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta gõ “.breakin” để switch từ user-mode debugging vào kernel-mode debugging, rồi gõ “bp cfs+573”, sau
                    đó ở crackinstaller ta gõ lệnh “g” thì ta sẽ dừng laị tại cfs+573.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; g</span><br><span class="line">0:000&gt; g</span><br><span class="line">Breakpoint 2 hit</span><br><span class="line">cfs+0x573:</span><br><span class="line">fffff880&#96;06530573 ff542428        call    qword ptr [rsp+28h]</span><br><span class="line">kd&gt; u poi(@rsp+28)</span><br><span class="line">00000000&#96;00070008 fb              sti</span><br><span class="line">00000000&#96;00070009 48ba2092300000000000 mov rdx,309220h</span><br><span class="line">00000000&#96;00070013 41b800580000    mov     r8d,5800h</span><br><span class="line">00000000&#96;00070019 41b970310000    mov     r9d,3170h</span><br><span class="line">00000000&#96;0007001f ff2500000000    jmp     qword ptr [00000000&#96;00070025]</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta step in để vào hàm ở [0x70025].</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; u @rip</span><br><span class="line">00000001&#96;3ffe2a10 44894c2420      mov     dword ptr [rsp+20h],r9d</span><br><span class="line">00000001&#96;3ffe2a15 4489442418      mov     dword ptr [rsp+18h],r8d</span><br><span class="line">00000001&#96;3ffe2a1a 4889542410      mov     qword ptr [rsp+10h],rdx</span><br><span class="line">00000001&#96;3ffe2a1f 53              push    rbx</span><br><span class="line">00000001&#96;3ffe2a20 55              push    rbp</span><br><span class="line">00000001&#96;3ffe2a21 56              push    rsi</span><br><span class="line">00000001&#96;3ffe2a22 57              push    rdi</span><br><span class="line">00000001&#96;3ffe2a23 4154            push    r12</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này chính là hàm <code>sub_140002A10</code> của crackinstaller.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">shellcode_140002A10</span><span class="params">(__int64 a1, <span class="keyword">const</span> <span class="keyword">void</span> *a2, <span class="keyword">unsigned</span> <span class="keyword">int</span> a3, <span class="keyword">unsigned</span> <span class="keyword">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//  truncated ...</span></span><br><span class="line">  v29 = a4;                                     <span class="comment">// 0x3170</span></span><br><span class="line">  v28 = a3;                                     <span class="comment">// 0x5800</span></span><br><span class="line">  v27 = a2;                                     <span class="comment">// DOS</span></span><br><span class="line">  v4 = a3;</span><br><span class="line">  v5 = <span class="number">0xC0000001</span>;</span><br><span class="line">  g_fnMmGetSystemRoutineAddress = (__int64 (__fastcall *)(_QWORD))a1;</span><br><span class="line">  get_g_imagebase_by_hash_140002768();</span><br><span class="line">  v22 = <span class="number">0</span>i64;</span><br><span class="line">  v23 = <span class="number">0</span>i64;</span><br><span class="line">  _mm_storeu_si128((__m128i *)&amp;v25, (__m128i)<span class="number">0</span>i64);</span><br><span class="line">  v21 = <span class="number">48</span>;</span><br><span class="line">  v24 = <span class="number">512</span>;</span><br><span class="line">  ExAllocatePoolWithTag = (__int64 (__fastcall *)(_QWORD, __int64, __int64))get_function_by_hash(<span class="number">0x490A231A</span>); </span><br><span class="line">  <span class="keyword">if</span> ( ExAllocatePoolWithTag )</span><br><span class="line">  &#123;</span><br><span class="line">    ExFreePoolWithTag = (<span class="keyword">void</span> (__fastcall *)(<span class="keyword">char</span> *, _QWORD))get_function_by_hash(<span class="number">0x34262863</span>); </span><br><span class="line">    <span class="keyword">if</span> ( ExFreePoolWithTag )</span><br><span class="line">    &#123;</span><br><span class="line">      IoCreateDriver = get_function_by_hash(<span class="number">0x1128974</span>);</span><br><span class="line">      <span class="keyword">if</span> ( IoCreateDriver )</span><br><span class="line">      &#123;</span><br><span class="line">        RtlImageNtHeader = get_function_by_hash(<span class="number">0xE2A9259B</span>); </span><br><span class="line">        <span class="keyword">if</span> ( RtlImageNtHeader )</span><br><span class="line">        &#123;</span><br><span class="line">          RtlImageDirectoryEntryToData = get_function_by_hash(<span class="number">0xCF424038</span>);</span><br><span class="line">          <span class="keyword">if</span> ( RtlImageDirectoryEntryToData )</span><br><span class="line">          &#123;</span><br><span class="line">            RtlQueryModuleInformation = get_function_by_hash(<span class="number">0xCE968D51</span>);</span><br><span class="line">            <span class="keyword">if</span> ( RtlQueryModuleInformation )</span><br><span class="line">            &#123;</span><br><span class="line">              PsCreateSystemThread = (__int64 (__fastcall *)(__int64 *, __int64, <span class="keyword">int</span> *, _QWORD, _QWORD, <span class="keyword">char</span> *, __int64))get_function_by_hash(<span class="number">0xB40D00D9</span>);<span class="comment">// </span></span><br><span class="line">              <span class="keyword">if</span> ( PsCreateSystemThread )</span><br><span class="line">              &#123;</span><br><span class="line">                ZwClose = (<span class="keyword">void</span> (__fastcall *)(__int64))get_function_by_hash(<span class="number">0xA95BE347</span>);</span><br><span class="line">                <span class="keyword">if</span> ( ZwClose )</span><br><span class="line">                &#123;</span><br><span class="line">                  v11 = v4;</span><br><span class="line">                  v12 = (<span class="keyword">char</span> *)ExAllocatePoolWithTag(<span class="number">0</span>i64, v4, <span class="number">0x52414C46</span>i64);</span><br><span class="line">                  <span class="keyword">if</span> ( v12 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v13 = ExAllocatePoolWithTag(<span class="number">0</span>i64, <span class="number">68</span>i64, <span class="number">0x52414C46</span>i64);</span><br><span class="line">                    v14 = v13;</span><br><span class="line">                    <span class="keyword">if</span> ( v13 )</span><br><span class="line">                    &#123;</span><br><span class="line">                      *(_QWORD *)v13 = ExAllocatePoolWithTag;</span><br><span class="line">                      *(_DWORD *)(v13 + <span class="number">56</span>) = v28;</span><br><span class="line">                      *(_QWORD *)(v13 + <span class="number">8</span>) = ExFreePoolWithTag;</span><br><span class="line">                      *(_QWORD *)(v13 + <span class="number">40</span>) = IoCreateDriver;</span><br><span class="line">                      *(_QWORD *)(v13 + <span class="number">48</span>) = v12;</span><br><span class="line">                      *(_QWORD *)(v13 + <span class="number">24</span>) = RtlImageDirectoryEntryToData;</span><br><span class="line">                      *(_QWORD *)(v13 + <span class="number">32</span>) = RtlQueryModuleInformation;</span><br><span class="line">                      v16 = v12;</span><br><span class="line">                      *(_QWORD *)(v14 + <span class="number">16</span>) = RtlImageNtHeader;</span><br><span class="line">                      qmemcpy(v12, v27, <span class="number">8</span> * (v11 &gt;&gt; <span class="number">3</span>));</span><br><span class="line">                      v17 = (<span class="keyword">unsigned</span> __int64)&amp;v12[v28 - <span class="number">8</span>];</span><br><span class="line">                      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)v12 &lt; v17 )</span><br><span class="line">                      &#123;</span><br><span class="line">                        <span class="keyword">do</span></span><br><span class="line">                        &#123;</span><br><span class="line">                          <span class="keyword">if</span> ( *(_QWORD *)v16 == <span class="number">0xDC16F3C3B57323</span>i64 )</span><br><span class="line">                          &#123;</span><br><span class="line">                            <span class="built_in">strcpy</span>(v16, <span class="string">&quot;BBACABA&quot;</span>);</span><br><span class="line">                          &#125;</span><br><span class="line">                          ++v16;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)v16 &lt; v17 );</span><br><span class="line">                      &#125;</span><br><span class="line">                      v5 = PsCreateSystemThread(&amp;threadHandle, <span class="number">0x10000000</span>i64, &amp;v21, <span class="number">0</span>i64, <span class="number">0</span>i64, &amp;v12[v29], v14);<span class="comment">// call driverBoostrap</span></span><br><span class="line">                      <span class="keyword">if</span> ( (v5 &amp; <span class="number">0x80000000</span>) == <span class="number">0</span> )</span><br><span class="line">                      &#123;</span><br><span class="line">                        ZwClose(threadHandle);</span><br><span class="line">                        <span class="keyword">return</span> v5;</span><br><span class="line">                      &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">   <span class="comment">// truncated ....</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm <code>sub_140002964</code> thực hiện việc tìm địa chỉ của function bằng hash, không cần RE hàm
                    này, chỉ cần quan sát qua debugger, ta có bảng sau:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Hash</th>
                            <th>Function</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>0x490A231A</td>
                            <td>ExAllocatePoolWithTag</td>
                        </tr>
                        <tr>
                            <td>0x34262863</td>
                            <td>ExFreePoolWithTag</td>
                        </tr>
                        <tr>
                            <td>0x1128974</td>
                            <td>IoCreateDriver</td>
                        </tr>
                        <tr>
                            <td>0xE2A9259B</td>
                            <td>RtlImageNtHeader</td>
                        </tr>
                        <tr>
                            <td>0xCF424038</td>
                            <td>RtlImageDirectoryEntryToData</td>
                        </tr>
                        <tr>
                            <td>0xCE968D51</td>
                            <td>RtlQueryModuleInformation</td>
                        </tr>
                        <tr>
                            <td>0xB40D00D9</td>
                            <td>PsCreateSystemThread</td>
                        </tr>
                        <tr>
                            <td>0xA95BE347</td>
                            <td>ZwClose</td>
                        </tr>
                    </tbody>
                </table>
                <p>Tiếp theo, ta đặt breakpoint ngay tại chỗ <code>v5 = PsCreateSystemThread(...)</code> và để chương
                    trình chạy tới đó.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; bp 1&#96;3ffe2c26</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 3 hit</span><br><span class="line">00000001&#96;3ffe2c26 ff542448        call    qword ptr [rsp+48h]</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta có hàm <code>PsCreateSystemThread</code> được định nghĩa như sau:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">NTSTATUS <span class="title">PsCreateSystemThread</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">  PHANDLE            ThreadHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  ULONG              DesiredAccess,</span></span></span><br><span class="line"><span class="function"><span class="params">  POBJECT_ATTRIBUTES ObjectAttributes,</span></span></span><br><span class="line"><span class="function"><span class="params">  HANDLE             ProcessHandle,</span></span></span><br><span class="line"><span class="function"><span class="params">  PCLIENT_ID         ClientId,</span></span></span><br><span class="line"><span class="function"><span class="params">  PKSTART_ROUTINE    StartRoutine,</span></span></span><br><span class="line"><span class="function"><span class="params">  PVOID              StartContext</span></span></span><br><span class="line"><span class="function"><span class="params">)</span></span>;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Trong đó <code>StartRoutine</code> là con trỏ tới hàm cần tạo thread. Nó là tham số thứ 6 trong hàm,
                    ta dùng lệnh “u poi(@rsp+28)” để disassemble hàm này:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; u poi(@rsp+28)</span><br><span class="line">fffffa80&#96;04472170 48894c2408      mov     qword ptr [rsp+8],rcx</span><br><span class="line">fffffa80&#96;04472175 56              push    rsi</span><br><span class="line">fffffa80&#96;04472176 57              push    rdi</span><br><span class="line">fffffa80&#96;04472177 4881ec88000000  sub     rsp,88h</span><br><span class="line">fffffa80&#96;0447217e 488d442448      lea     rax,[rsp+48h]</span><br><span class="line">fffffa80&#96;04472183 488bf8          mov     rdi,rax</span><br><span class="line">fffffa80&#96;04472186 33c0            xor     eax,eax</span><br><span class="line">fffffa80&#96;04472188 b930000000      mov     ecx,30h</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta đặt breakpoint ngay tại hàm này và bấm “g” để dừng lại ngay tại hàm này.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; bp fffffa80&#96;04472170</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 4 hit</span><br><span class="line">fffffa80&#96;04472170 48894c2408      mov     qword ptr [rsp+8],rcx</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta đang dừng lại ngay hàm <code>DriverBootstrap</code> của file PE thứ 2.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">DriverBootstrap</span><span class="params">(PARAM *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> 	<span class="comment">// truncated ...</span></span><br><span class="line">              <span class="keyword">if</span> ( v5 )</span><br><span class="line">              &#123;</span><br><span class="line">                v7 = (IMAGE_SECTION_HEADER *)((<span class="keyword">char</span> *)&amp;v6-&gt;OptionalHeader + v6-&gt;FileHeader.SizeOfOptionalHeader);</span><br><span class="line">                qmemcpy(v5, v15-&gt;pAllocateMemory_0x5800, <span class="number">8</span> * (v6-&gt;OptionalHeader.SizeOfHeaders / <span class="number">8u</span>i64));</span><br><span class="line">                <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v6-&gt;FileHeader.NumberOfSections; ++i )</span><br><span class="line">                &#123;</span><br><span class="line">                  qmemcpy(</span><br><span class="line">                    (<span class="keyword">char</span> *)v5 + v7[i].VirtualAddress,</span><br><span class="line">                    (<span class="keyword">char</span> *)v15-&gt;pAllocateMemory_0x5800 + v7[i].PointerToRawData,</span><br><span class="line">                    <span class="number">8</span> * (v7[i].SizeOfRawData / <span class="number">8u</span>i64));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( (<span class="keyword">int</span>)mb_fixup_140003B80((__int64)&amp;pExAllocatePoolWithTag, (__int64)v5) &gt;= <span class="number">0</span></span><br><span class="line">                  &amp;&amp; (<span class="keyword">int</span>)mb_find_import_140003FE0((tbl *)&amp;pExAllocatePoolWithTag, (__int64)v5, v1) &gt;= <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  v14 = (IMAGE_DOS_HEADER *)((<span class="keyword">char</span> *)v5 + v6-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line">                  <span class="keyword">if</span> ( v14 )</span><br><span class="line">                  &#123;</span><br><span class="line">                    v4 = pIoCreateDriver(<span class="number">0</span>i64, v14);</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                  &#123;</span><br><span class="line">                    v4 = <span class="number">0xC0000001</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line"> <span class="comment">// truncated ...</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này thực hiện 1 việc rất giống Reflective DLL load, và đúng là như vậy, đoạn code trên được copy
                    từ <a target="_blank" rel="noopener"
                        href="https://github.com/Professor-plum/Reflective-Driver-Loader/blob/master/reflective_driver/Stub.cpp">đây,
                        reflective driver loader</a> (trong repo này cũng sử dụng lại capcom.sys để làm ví dụ).</p>
                <p>Ta thấy sau khi thực hiện load và fix bảng IAT, reloc table, thì nó gọi IOCreateDriver để gọi
                    <code>DriverEntry</code> của file PE thứ 2.
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">NTSTATUS __stdcall <span class="title">DriverEntry</span><span class="params">(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">DRIVER_OBJECT</span> *<span class="title">v2</span>;</span> <span class="comment">// rdi</span></span><br><span class="line"></span><br><span class="line">  v2 = DriverObject;</span><br><span class="line">  _security_init_cookie();</span><br><span class="line">  <span class="keyword">return</span> sub_140009000(v2);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140009000</span><span class="params">(struct _DRIVER_OBJECT *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  	<span class="comment">// truncated ...</span></span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">	<span class="comment">// truncated ...</span></span><br><span class="line">    v2 = CmRegisterCallbackEx(sub_140004570, &amp;v5, DriverObject, DriverObject, &amp;Cookie, <span class="number">0</span>i64);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="comment">// truncated ...</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở driver này, nó dùng hàm <code>sub_140004570</code> để làm hàm callback, ta lại tiếp tục phân tích
                    hàm này.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_140004570</span><span class="params">(__int64 a1, __int64 a2, <span class="keyword">unsigned</span> __int16 **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// truncated ...</span></span><br><span class="line">         <span class="keyword">if</span> ( wcsstr(Str, v3) ) <span class="comment">// &#123;CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7&#125;\Config</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v26, <span class="number">0</span>, <span class="number">0x70</span>ui64);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v25, <span class="number">0</span>, <span class="number">0x20</span>ui64);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v27, <span class="number">0</span>, <span class="number">0x88</span>ui64);</span><br><span class="line">        <span class="built_in">memset</span>(&amp;v19, <span class="number">0</span>, <span class="number">8u</span>i64);</span><br><span class="line">        <span class="built_in">memset</span>(v22, <span class="number">0</span>, <span class="keyword">sizeof</span>(v22));</span><br><span class="line">        sub_1400034F0(&amp;v26); <span class="comment">// sha256 init</span></span><br><span class="line">        sub_140003AD0(&amp;v26, &amp;unk_14000608C, <span class="number">7</span>i64); <span class="comment">// sha256 update</span></span><br><span class="line">        sub_140003120(&amp;v26, &amp;v25); <span class="comment">// sha256 final</span></span><br><span class="line">        sub_140002760(&amp;v27, &amp;v25, <span class="number">32</span>i64, &amp;v19); <span class="comment">// init modified salsa20 </span></span><br><span class="line">        sub_140002490(&amp;v27, &amp;unk_140006078, v22, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)dword_140006088); <span class="comment">// salsa decrypt</span></span><br><span class="line">        Class.Length = <span class="number">2</span> * dword_140006088;</span><br><span class="line">        Class.MaximumLength = <span class="number">2</span> * (dword_140006088 + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; dword_140006088; ++i )</span><br><span class="line">          Class.Buffer[i] = (<span class="keyword">unsigned</span> __int8)v22[i];</span><br><span class="line">        v24.Length = <span class="number">48</span>;</span><br><span class="line">        v24.RootDirectory = <span class="number">0</span>i64;</span><br><span class="line">        v24.Attributes = <span class="number">512</span>;</span><br><span class="line">        v24.ObjectName = <span class="number">0</span>i64;</span><br><span class="line">        v24.SecurityDescriptor = <span class="number">0</span>i64;</span><br><span class="line">        v24.SecurityQualityOfService = <span class="number">0</span>i64;</span><br><span class="line">        ObjectAttributes.Length = <span class="number">48</span>;</span><br><span class="line">        ObjectAttributes.RootDirectory = <span class="number">0</span>i64;</span><br><span class="line">        ObjectAttributes.Attributes = <span class="number">576</span>;</span><br><span class="line">        ObjectAttributes.ObjectName = v12;</span><br><span class="line">        ObjectAttributes.SecurityDescriptor = <span class="number">0</span>i64;</span><br><span class="line">        ObjectAttributes.SecurityQualityOfService = <span class="number">0</span>i64;</span><br><span class="line">        ZwCreateKey(&amp;KeyHandle, <span class="number">0xF003F</span>u, &amp;ObjectAttributes, <span class="number">0</span>, &amp;Class, <span class="number">0</span>, (PULONG)v8[<span class="number">8</span>]);</span><br><span class="line">        ObReferenceObjectByHandle(KeyHandle, *((_DWORD *)v8 + <span class="number">14</span>), (POBJECT_TYPE)v8[<span class="number">2</span>], <span class="number">0</span>, &amp;Object, <span class="number">0</span>i64);</span><br><span class="line">        ZwClose(KeyHandle);</span><br><span class="line"> <span class="comment">// truncated ...</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Driver này sẽ theo dõi những thay đổi trong Registry, nếu trong path của key có chứa
                    “{CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7}\Config” thì đoạn code trên sẽ được thực hiện.</p>
                <p>Ta sẽ tìm cách đặt breakpoint tại hàm này. (Hiện tại ta vẫn đang ở đầu của hàm
                    <code>DriverBootstrap</code>).
                </p>
                <p>Ta dùng lệnh “bp nt!CmRegisterCallbackEx” , sau đó bấm “g”, ta sẽ dừng ngay đầu hàm này.</p>
                <p>Tiếp theo ta gõ “bp @rcx”, đây chính là địa chỉ hàm callback.</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; bp nt!CmRegisterCallbackEx</span><br><span class="line">kd&gt; g</span><br><span class="line">Breakpoint 5 hit</span><br><span class="line">nt!CmRegisterCallbackEx:</span><br><span class="line">fffff800&#96;02ad0d30 4883ec38        sub     rsp,38h</span><br><span class="line">kd&gt; u @rcx</span><br><span class="line">fffffa80&#96;045e5570 4c89442418      mov     qword ptr [rsp+18h],r8</span><br><span class="line">fffffa80&#96;045e5575 4889542410      mov     qword ptr [rsp+10h],rdx</span><br><span class="line">fffffa80&#96;045e557a 48894c2408      mov     qword ptr [rsp+8],rcx</span><br><span class="line">fffffa80&#96;045e557f 56              push    rsi</span><br><span class="line">fffffa80&#96;045e5580 57              push    rdi</span><br><span class="line">fffffa80&#96;045e5581 4881ecf8030000  sub     rsp,3F8h</span><br><span class="line">fffffa80&#96;045e5588 488b842420040000 mov     rax,qword ptr [rsp+420h]</span><br><span class="line">fffffa80&#96;045e5590 4889442458      mov     qword ptr [rsp+58h],rax</span><br><span class="line">kd&gt; bp @rcx</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta bấm “g” để chạy và dừng ngay tại hàm callback.</p>
                <p>Giờ ta chỉ quan tâm tới lời gọi “ZwCreateKey” ở trong đoạn if nên: “bp @rip+0x56d, sau đó bấm “g”.
                </p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">0:000&gt; g</span><br><span class="line">ModLoad: 000007fe&#96;fb640000 000007fe&#96;fb660000   C:\Users\admin\AppData\Local\Microsoft\Credentials\credHelper.dll</span><br><span class="line">Breakpoint 2 hit</span><br><span class="line">fffffa80&#96;045acadd ff15c5050000    call    qword ptr [fffffa80&#96;045ad0a8]</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Tham số thứ 5 của hàm <code>ZwCreate</code> là những gì mà ta quan tâm, nên:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">kd&gt; dS poi(@rsp+20)</span><br><span class="line">fffff880&#96;06fe2180  &quot;H@n $h0t FiRst!&quot;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Yay, đây cũng chính là Password, giờ ta chỉ việc viết 1 chương trình nhỏ để gọi hàm decrypt flag
                    trong credHelper.dll là xong. Ở đây mình không xài các hàm <code>COM</code> mà dùng thẳng vtable như
                    trong C++ luôn.</p>
                <figure class="highlight c">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ObjectVTable</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span>(__fastcall *dontknow)(PVOID pThis);</span><br><span class="line">    <span class="keyword">void</span>(__fastcall *incRefCount)(PVOID pThis);</span><br><span class="line">    <span class="keyword">void</span>(__fastcall *decRefCount)(PVOID pThis);</span><br><span class="line">    ULONGLONG(__fastcall *rc4Init)(PVOID pThis, BYTE* pArray);</span><br><span class="line">    ULONGLONG(__fastcall *decryptFlag)(PVOID pThis, BYTE* pArray);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Object</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ObjectVTable</span>* <span class="title">vtbl</span>;</span></span><br><span class="line">    ULONGLONG refCount;</span><br><span class="line">    <span class="keyword">char</span> pad[<span class="number">0x1000</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">setPassword</span><span class="params">(BYTE* password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BOOL bRet = TRUE;</span><br><span class="line">    HKEY hSubKey;</span><br><span class="line">    <span class="keyword">if</span> (RegOpenKeyW(HKEY_CLASSES_ROOT, <span class="string">L&quot;CLSID\\&#123;CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7&#125;\\Config&quot;</span>, &amp;hSubKey) != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        bRet = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RegSetValueExA(hSubKey, <span class="string">&quot;Password&quot;</span>, <span class="number">0</span>, REG_SZ, (<span class="keyword">const</span> BYTE*)password, (lstrlenA(password) + <span class="number">1</span>) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>)) != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        bRet = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bRet)</span><br><span class="line">    &#123;   </span><br><span class="line">        RegCloseKey(hSubKey);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">printFlag</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">wchar_t</span> flag[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">int</span> size = <span class="keyword">sizeof</span>(flag);</span><br><span class="line">    <span class="built_in">memset</span>(flag, <span class="number">0</span>, size);</span><br><span class="line">    BOOL bRet = TRUE;</span><br><span class="line">    <span class="keyword">if</span> (RegGetValueW(HKEY_CLASSES_ROOT, <span class="string">L&quot;CLSID\\&#123;CEEACC6E-CCB2-4C4F-BCF6-D2176037A9A7&#125;\\Config&quot;</span>, <span class="string">L&quot;Flag&quot;</span>, RRF_RT_REG_SZ, <span class="number">0</span>, flag, &amp;size)  != ERROR_SUCCESS)</span><br><span class="line">    &#123;</span><br><span class="line">        bRet = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (bRet)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;-&gt; %s\n&quot;</span>, flag);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bRet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">readFlag</span><span class="params">(BYTE* password)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HMODULE hModule = LoadLibraryW(<span class="string">L&quot;credHelper.dll&quot;</span>);</span><br><span class="line">    ULONG_PTR pBase = (ULONG_PTR)hModule;</span><br><span class="line">    <span class="keyword">if</span> (setPassword(password) == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;[+] Error setPassword, (%d)\n&quot;</span>, (BYTE)password[<span class="number">0</span>]);</span><br><span class="line">        ExitProcess(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//system(&quot;pause&quot;);</span></span><br><span class="line">    <span class="keyword">if</span> (pBase == (ULONG_PTR)<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;[+] Error LoadLibrary, (%d)\n&quot;</span>, (BYTE)password[<span class="number">0</span>]);</span><br><span class="line">        ExitProcess(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    BYTE arr[<span class="number">0x1000</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Object</span>* <span class="title">object</span> =</span> (struct Object*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct Object));</span><br><span class="line">    object-&gt;vtbl = (struct ObjectVTable*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct ObjectVTable));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(object-&gt;vtbl, (PVOID)(<span class="number">0x17908</span>ULL + pBase), <span class="keyword">sizeof</span>(struct ObjectVTable)); <span class="comment">// copy the vtable</span></span><br><span class="line"></span><br><span class="line">    object-&gt;vtbl-&gt;incRefCount(object);</span><br><span class="line"></span><br><span class="line">    wprintf(<span class="string">L&quot;[+] Ret: 0x%llx\n&quot;</span>, object-&gt;vtbl-&gt;rc4Init(object, arr));</span><br><span class="line">    wprintf(<span class="string">L&quot;[+] Ret: 0x%llx\n&quot;</span>, object-&gt;vtbl-&gt;decryptFlag(object, arr));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    printFlag();</span><br><span class="line"></span><br><span class="line">    object-&gt;vtbl-&gt;decRefCount(object);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(object-&gt;vtbl);</span><br><span class="line">    <span class="built_in">free</span>(object);</span><br><span class="line">    <span class="keyword">if</span> (FreeLibrary(hModule) == FALSE)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(<span class="string">L&quot;[+] Free error\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wmain</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">wchar_t</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BYTE password[] = &#123; <span class="number">0x48</span>, <span class="number">0x40</span>, <span class="number">0x6e</span>, <span class="number">0x20</span>, <span class="number">0x24</span>, <span class="number">0x68</span>, <span class="number">0x30</span>, <span class="number">0x74</span>, <span class="number">0x20</span>, <span class="number">0x46</span> ,<span class="number">0x69</span>, <span class="number">0x52</span> ,<span class="number">0x73</span> ,<span class="number">0x74</span> ,<span class="number">0x21</span>, <span class="number">0x00</span> &#125;;</span><br><span class="line">    readFlag(password);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Run:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">C:\Users\admin\Desktop&gt;9.exe</span><br><span class="line">[+] Ret: 0x0</span><br><span class="line">[+] Ret: 0x0</span><br><span class="line">-&gt; S0_m@ny_cl@sse$_in_th3_Reg1stry@flare-on.com</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">S0_m@ny_cl@sse$_in_th3_Reg1stry@flare-on.com</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <h1 id="10-break"><a href="#10-break" class="headerlink" title="10 - break">10 - break</a></h1>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">As a reward for making it this far in Flare-On, we&#39;ve decided to give you a break. Welcome to the land of sunshine and rainbows!</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p><img src="/images/flareon/10/1.png"></p>
                <p>Ở bài này chúng ta có 1 file ELF. Chạy thử:</p>
                <p><img src="/images/flareon/10/2.png"></p>
                <p>Program xuất ra “sorry i stole your input”, vậy có thể là input của ta nhập vào bằng cách nào đó đã
                    bị đổi. Giờ ta mở file lên trong IDA.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl __noreturn <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">264</span>]; <span class="comment">// [esp+0h] [ebp-108h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;welcome to the land of sunshine and rainbows!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;as a reward for getting this far in FLARE-ON, we&#x27;ve decided to make this one soooper easy&quot;</span>);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;please enter a password friend :) &quot;</span>);</span><br><span class="line">  buf[read(<span class="number">0</span>, buf, <span class="number">0xFF</span>u) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( sub_8048CDB(buf) )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hooray! the flag is: %s\n&quot;</span>, buf);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sorry, but &#x27;%s&#x27; is not correct\n&quot;</span>, buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">sub_8048CDB</span><span class="params">(<span class="keyword">char</span> *s1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(s1, <span class="string">&quot;sunsh1n3_4nd_r41nb0ws@flare-on.com&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Quá tuyệt vời, có luôn flag: “<a
                        href="mailto:&#115;&#x75;&#110;&#x73;&#x68;&#x31;&#x6e;&#51;&#95;&#x34;&#x6e;&#x64;&#95;&#114;&#52;&#x31;&#x6e;&#98;&#48;&#119;&#x73;&#x40;&#102;&#108;&#x61;&#x72;&#101;&#x2d;&#x6f;&#x6e;&#x2e;&#x63;&#x6f;&#x6d;">&#115;&#x75;&#110;&#x73;&#x68;&#x31;&#x6e;&#51;&#95;&#x34;&#x6e;&#x64;&#95;&#114;&#52;&#x31;&#x6e;&#98;&#48;&#119;&#x73;&#x40;&#102;&#108;&#x61;&#x72;&#101;&#x2d;&#x6f;&#x6e;&#x2e;&#x63;&#x6f;&#x6d;</a>“.
                </p>
                <p><img src="/images/flareon/10/3.png"></p>
                <p>Nhưng vẫn không đúng, ta vẫn bị “steal input”. Ta dùng tool strings và grep để tìm chuỗi “sorry i
                    stole your input :)”:</p>
                <p><img src="/images/flareon/10/4.png"></p>
                <p>Không tìm được chuỗi nào như vậy, có thể chuỗi này được build trên stack, nên không thể tìm thấy bằng
                    tool strings.</p>
                <p>Ở bài này mình lại quên mất 1 điều là: trước khi chạy hàm main thì program sẽ chạy các hàm
                    Constructor. Để vào được tới hàm main, ở <a target="_blank" rel="noopener"
                        href="http://dbp-consulting.com/tutorials/debugging/linuxProgramStartup.html">bài này</a> có
                    giải thích khá rõ. Để tóm tắt lại thì, mình để cái hình ở đây, cũng khá là dễ hiểu:</p>
                <p><img src="/images/flareon/10/5.png"></p>
                <p>Ta xem code của hàm <code>_init</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// edi</span></span><br><span class="line"></span><br><span class="line">  init_proc();</span><br><span class="line">  v0 = &amp;off_81A4F04 - funcs_8056364;</span><br><span class="line">  <span class="keyword">if</span> ( v0 )</span><br><span class="line">  &#123;</span><br><span class="line">    v1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      funcs_8056364[v1++]();</span><br><span class="line">    <span class="keyword">while</span> ( v1 != v0 );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.init_array:081A4EFC funcs_8056364   dd offset sub_8048CB0</span><br><span class="line">.init_array:081A4EFC                 dd offset sub_8048FC5</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở đây có 2 hàm Constructor, 1 hàm ở 0x8048CB0, 1 hàm ở 0x8048FC5. Vì hàm ở 0x8048CB0 không có gì
                    nhiều nên ta phân tích hàm ở 0x8048FC5.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sub_8048FC5</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> pid; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  pid = getpid();</span><br><span class="line">  parrent_pid = pid;</span><br><span class="line">  <span class="keyword">if</span> ( !fork() )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_80490C4(pid);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  prctl(<span class="number">0x59616D61</span>, pid, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  nanosleep(requested_time, <span class="number">0</span>);</span><br><span class="line">  v0 = nice(<span class="number">170</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, -v0);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở hàm này, program tạo ra process con bằng <code>fork</code>, process con sẽ thực thi hàm
                    <code>sub_80490C4</code>, ta tiếp tục đến hàm này.
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">call_ptrace_dynamic</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> *handle; <span class="comment">// ST18_4</span></span><br><span class="line">  <span class="keyword">int</span> (__cdecl *v5)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>); <span class="comment">// ST1C_4</span></span><br><span class="line"></span><br><span class="line">  handle = dlopen(<span class="string">&quot;libc.so.6&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  v5 = (<span class="keyword">int</span> (__cdecl *)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>))dlsym(handle, <span class="string">&quot;ptrace&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v5(a1, a2, a3, a4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_80490C4</span><span class="params">(<span class="keyword">__pid_t</span> parrent_pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v50 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( call_ptrace_dynamic(PTRACE_ATTACH, parrent_pid, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v49 = sub_804BD69(parrent_pid);             <span class="comment">// return &quot;TracerPid&quot; in &quot;/proc/pid/status&quot; if found</span></span><br><span class="line">    <span class="keyword">if</span> ( v49 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( call_ptrace_dynamic(PTRACE_ATTACH, v49, <span class="number">0</span>, <span class="number">0</span>) == <span class="number">-1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        kill(v49, SIGKILL);</span><br><span class="line">        result = kill(parrent_pid, <span class="number">9</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          result = waitpid(v49, &amp;v16, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ( result == <span class="number">-1</span> )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          v35 = v16;</span><br><span class="line">          <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)v16 == <span class="number">127</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v36 = v16;</span><br><span class="line">            v48 = (v16 &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v48 != <span class="number">19</span> &amp;&amp; v48 != <span class="number">17</span> )</span><br><span class="line">              call_ptrace_dynamic(<span class="number">7</span>, v49, <span class="number">0</span>, v48);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              call_ptrace_dynamic(<span class="number">7</span>, v49, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// truncated ....</span></span><br><span class="line">  &#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này nhận 1 tham số là pid của process cha. Đoạn code trên kiểm tra xem process cha có đang bị
                    process khác trace (debug) không. Có thể đây là 1 kỹ thuật anti-debug.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  result = waitpid(parrent_pid, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( call_ptrace_dynamic(PTRACE_POKEDATA, parrent_pid, (<span class="keyword">int</span>)sub_8048CDB, <span class="number">0xB0F</span>) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    signal(<span class="number">14</span>, handler);</span><br><span class="line">    v2 = getpid();</span><br><span class="line">    create_child_and_trace_me_please_804A0B4(v2);</span><br><span class="line">    v47 = (<span class="keyword">void</span> **)&amp;unk_81A52A0;</span><br><span class="line">    unk_81A52A0 = <span class="number">0</span>;</span><br><span class="line">    call_ptrace_dynamic(<span class="number">31</span>, parrent_pid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// truncated ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// truncated ...</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở đoạn này, process con write giá trị (32 bit) 0xB0F vào địa chỉ 0x8048CDB của process cha, sau đó nó
                    lại tạo ra thêm 1 process con nữa bằng hàm 0x804A0B4 (hàm này gọi tiếp hàm 0x8049C9C):</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">__pid_t</span> __cdecl <span class="title">sub_8049C9C</span><span class="params">(<span class="keyword">__pid_t</span> pid)</span> <span class="comment">// &lt;-- this func receives 1st child&#x27;s PID</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  prctl(<span class="number">4</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  signal(SIGINT, (<span class="keyword">__sighandler_t</span>)<span class="number">1</span>);</span><br><span class="line">  signal(SIGQUIT, (<span class="keyword">__sighandler_t</span>)<span class="number">1</span>);</span><br><span class="line">  signal(SIGTERM, (<span class="keyword">__sighandler_t</span>)<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( call_ptrace_dynamic(PTRACE_ATTACH, pid, <span class="number">0</span>, <span class="number">0</span>) != <span class="number">-1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// a lot of &quot;if&quot; statements here ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;OOPSIE WOOPSIE!! Uwu We made a mistaky wakey!!!!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> kill(pid, <span class="number">9</span>);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi process con tạo ra process con thứ 2, thì nó tiếp tục nhảy vào vòng lặp với rất nhiều câu
                    lệnh <code>if</code>, <code>switch</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    result = waitpid(parrent_pid, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( result == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v27 = stat_loc;</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)stat_loc == <span class="number">127</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v28 = stat_loc;</span><br><span class="line">      <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">19</span> )</span><br><span class="line">         call_ptrace_dynamic(<span class="number">31</span>, parrent_pid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      v29 = stat_loc;</span><br><span class="line">      <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">5</span> )</span><br><span class="line">         <span class="comment">// .. truncated</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// .. truncated ....</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đến giờ ta có 1 số thông tin như sau:</p>
                <ul>
                    <li>Process con 1 gọi <code>ptrace(PTRACE_ATTACH, ...)</code> lên process cha.</li>
                    <li>Process con 2 gọi <code>ptrace(PTRACE_ATTACH, ...)</code> lên process con 1.</li>
                    <li>Ca 2 process con đều thực thi 1 vòng lặp <code>while (1)</code> với rất nhiều <code>if</code> ,
                        <code>switch</code>, và gọi rất nhiều <code>ptrace</code> ở trong vòng lặp đó.
                    </li>
                </ul>
                <blockquote>
                    <p><code>PTRACE_ATTACH</code> thường được gọi khi 1 debugger muốn debug process khác.</p>
                </blockquote>
                <p>Mình tìm thấy trên mạng có một số bài viết rất hay về <code>ptrace</code> (nếu bạn chưa biết nhiều về
                    hàm <code>ptrace</code> thì có thể đọc các bài dưới đây để hiểu thêm về nó):</p>
                <ul>
                    <li><a target="_blank" rel="noopener" href="https://www.linuxjournal.com/article/6100">Playing with
                            PTRACE part 1</a></li>
                    <li><a target="_blank" rel="noopener" href="https://www.linuxjournal.com/article/6210">Playing with
                            PTRACE part 2</a></li>
                    <li><a target="_blank" rel="noopener"
                            href="https://eli.thegreenplace.net/2011/01/23/how-debuggers-work-part-1">How debugger
                            works</a></li>
                    <li><a target="_blank" rel="noopener" href="http://www.alexonlinux.com/how-debugger-works">How
                            debugger works 2</a></li>
                </ul>
                <p>Mình sẽ tóm tắt lại tác dụng của 1 số câu lệnh <code>ptrace</code> được gọi trong chương trình này ở
                    dưới:</p>
                <ul>
                    <li><code>ptrace(PTRACE_ATTACH, pid, 0, 0)</code>: attach vào 1 process có pid là <code>pid</code>.
                    </li>
                    <li><code>ptrace(PTRACE_POKEDATA, pid, where, val)</code>: giá trị <code>val</code> kiểu dữ liệu là
                        <code>long</code> vào địa chỉ <code>where</code> của process có PID là <code>pid</code>.
                    </li>
                    <li><code>ptrace(PTRACE_PEEKDATA), pid, where, 0)</code>: đọc giá trị <code>long</code> tại địa chỉ
                        <code>where</code> của process có PID là <code>pid</code>.
                    </li>
                    <li><code>ptrace(PTRACE_SETREGS, pid, 0, &amp;regs)</code>: ghi đè thanh ghi của process có PID là
                        <code>pid</code> bằng các giá trị lưu trong <code>regs</code>.
                    </li>
                    <li><code>ptrace(PTRACE_CONT, pid, 0, 0)</code>: tương tự lệnh <code>continue</code> trong
                        <code>gdb</code>.
                    </li>
                    <li><code>ptrace(PTRACE_GETREGS, parrent_pid, 0, &amp;regs)</code>: lấy giá trị các thanh ghi của
                        process có PID là <code>pid</code> và lưu vào <code>regs</code>.</li>
                    <li><code>ptrace(31, ...)</code>: (<code>ptrace(PTRACE_SYSEMU, ...)</code>): khi gặp 1 syscall, đừng
                        execute syscall đó mà để debugger xử lý. <a target="_blank" rel="noopener"
                            href="https://stackoverflow.com/questions/5395769/any-good-guides-on-using-ptrace-sysemu">Tham
                            khảo</a>.</li>
                </ul>
                <p>Đến đây ta có thể nhận ra:</p>
                <ul>
                    <li>Process 1 giống như debugger và nó điều khiển process cha.</li>
                    <li>Process 2 giống như debugger và nó điều khiển process con 1.</li>
                </ul>
                <p>Bốn bài viết ở trên hướng dẫn cách viêt 1 debugger đơn giản, pattern của debugger này là:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    reason = recv_reason(pid); <span class="comment">// Lấy lý do process bị stop</span></span><br><span class="line">    process(pid); <span class="comment">// xử lý (tiếp tục chạy, hoặc step 1 lệnh, đổi thanh ghi, thoát, ...)</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Để lấy “lí do”, ta có thể sử dụng 1 trong các hàm <a target="_blank" rel="noopener"
                        href="https://linux.die.net/man/2/waitpid">wait</a>.</p>
                <p>Ta cùng xem lại vòng lặp <code>while (1)</code> của process con 1:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    result = waitpid(parrent_pid, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// ... truncated</span></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)stat_loc == <span class="number">127</span> ) </span><br><span class="line">    &#123;</span><br><span class="line">    	<span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">19</span> ) &#123; <span class="comment">/* ... */</span> &#125; <span class="comment">// 19 = SIGSTOP</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">5</span> ) &#123; <span class="comment">/* ... */</span> &#125;  <span class="comment">// 5 = SIGTRAP</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">4</span> ) &#123; <span class="comment">/*... */</span> &#125;   <span class="comment">// 4 = SIGILL</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">11</span> ) &#123; <span class="comment">/* ... */</span> &#125; <span class="comment">// 11 = SIGSEGV</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">2</span> ) &#123; <span class="comment">/* ... */</span> &#125;  <span class="comment">// 2 = SIGINT</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">15</span> ) &#123; <span class="comment">/* ... */</span> &#125; <span class="comment">// 15 = SIGTERM</span></span><br><span class="line">        <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == <span class="number">3</span> ) &#123; <span class="comment">/* ... */</span> &#125; <span class="comment">// 3 = SIGQUIT</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... truncated</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta thấy sau khi lấy được <code>stat_loc</code> bằng hàm <code>waitpid</code>, chương trình sử dụng
                    giá trị sau:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">(stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn trên được tạo ra bởi macro <code>WSTOPSIG</code>, dùng để lấy “lí do” mà process dừng lại:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     source: https://unix.superglobalmegacorp.com/Net2/newsrc/sys/wait.h.html</span></span><br><span class="line"><span class="comment">     file: sys/wait.h</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	_W_INT(w)	(*(int *)&amp;(w))	<span class="comment">/* convert union wait to int */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WSTOPSIG(x)	(_W_INT(x) &gt;&gt; 8)</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy là tùy vào “lí do” mà process con 1 sẽ điều khiển process cha như thế nào.</p>
                <p>Trước khi đi tiếp, ta cần hiểu ý nghĩa của một số kết quả trả về bởi <code>WSTOPSIG</code>:</p>
                <ul>
                    <li><code>SIGTRAP</code>: process dừng lại vì nó vừa gặp phải lệnh syscall.</li>
                    <li><code>SIGILL</code>: process dừng lại vì CPU phải thực thi 1 lệnh asm không hợp lệ.</li>
                    <li><code>SIGSEGV</code>: process dừng lại vì nó vừa truy cập vùng nhớ mà nó không được phép (vd:
                        truy cập vùng nhớ không được phép).</li>
                </ul>
                <blockquote>
                    <p>Vì process con 1 điều khiển process cha thông qua việc làm “debugger”, nên mình không thể debug
                        program này. Tuy nhiên mình có 1 cách khác để log lại các hàm được gọi, sẽ được viết ở dưới.</p>
                </blockquote>
                <p>Việc phân tích tĩnh khá cực, vì nó rất dễ nhầm lẫn, process con 1 lại còn bị “debug” bởi process con
                    2 nữa nên mình hoàn toàn không biết cách nào để debug chương trình này.</p>
                <p>Tuy nhiên có 1 kỹ thuật LD_PRELOAD dùng để hook library function trên linux, bạn đọc có thể tham khảo
                    <a target="_blank" rel="noopener"
                        href="https://www.mike-gualtieri.com/posts/hooking-linux-libraries-for-post-exploitation-fun">tại
                        đây</a>.
                </p>
                <p>Vì program này gọi <code>ptrace</code> rất nhiều nên việc đầu tiên mình làm là hook hàm
                    <code>ptrace</code>. Tuy nhiên, program này không gọi trực tiếp <code>ptrace</code>, mà nó gọi thông
                    qua con trỏ hàm:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">call_ptrace_dynamic</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  handle = dlopen(<span class="string">&quot;libc.so.6&quot;</span>, <span class="number">1</span>);</span><br><span class="line">  v5 = (<span class="keyword">int</span> (__cdecl *)(<span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>, <span class="keyword">int</span>))dlsym(handle, <span class="string">&quot;ptrace&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> v5(a1, a2, a3, a4);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Như vậy, mình không hook <code>ptrace</code> nữa mà mình hook <code>dlsym</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">hooked_ptrace</span><span class="params">(<span class="keyword">enum</span> __ptrace_request request, <span class="keyword">pid_t</span> pid, <span class="keyword">void</span> *addr, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> r = ptrace(request, pid, addr, data);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)request != <span class="number">31</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[+] ptrace(%s, %d, %p, %p) = %lu (%lX) (&#x27;%c%c%c%c&#x27;)\n&quot;</span>, be_req(request), pid, addr,</span><br><span class="line">                data, r, r, (<span class="keyword">char</span>)r&amp;<span class="number">0xFF</span>, (<span class="keyword">char</span>)(r&gt;&gt;<span class="number">8</span>)&amp;<span class="number">0xFF</span>, (<span class="keyword">char</span>)(r&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xFF</span>, (<span class="keyword">char</span>)(r&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xFF</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">int</span>)request == <span class="number">0xC</span> || (<span class="keyword">int</span>)request == <span class="number">0xD</span>)</span><br><span class="line">        print_regs(data);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">void</span> *_dl_sym(<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">char</span> *, <span class="keyword">void</span> *);</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> *<span class="title">dlsym</span><span class="params">(<span class="keyword">void</span> *handle, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name,<span class="string">&quot;dlsym&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">void</span>*)dlsym;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(name,<span class="string">&quot;ptrace&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">void</span>*)hooked_ptrace;</span><br><span class="line">    <span class="keyword">return</span> _dl_sym(handle, name, dlsym);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Mình đặt tên file này là “libexample.c”. Compile và hook thử:</p>
                <figure class="highlight bash">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">gcc libexample.c -o libexample.so -fPIC -shared -ldl -D_GNU_SOURCE -m32 -w &amp;&amp; LD_PRELOAD=./libexample.so ./<span class="built_in">break</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p><img src="/images/flareon/10/6.png"></p>
                <p>Hook đã hoạt động đúng như ta muốn, ở trên ta có thể thấy chuỗi “sorry i stole …” được build bằng
                    cách dùng <code>ptrace(PTRACE_PEEKDATA, ...)</code> để đọc từ process khác, đó là lí do ta không
                    thấy chuỗi đó khi dùng strings.</p>
                <p>Bây giờ ta bắt đầu quay lại phân tích flow của process con 1. Bắt đầu từ việc process con này viết
                    giá trị 0xB0F vào process cha như đã nói ở trên.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">call_ptrace_dynamic(PTRACE_POKEDATA, parrent_pid, (<span class="keyword">int</span>)sub_8048CDB, <span class="number">0xB0F</span>);</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Trong đó, hàm <code>sub_8048CDB</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">sub_8048CDB</span><span class="params">(<span class="keyword">char</span> *s1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(s1, <span class="string">&quot;sunsh1n3_4nd_r41nb0ws@flare-on.com&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy là nó đã thay đổi instruction đầu tiên của hàm này (điều này cũng giải thích tại sao ta nhập “<a
                        href="mailto:&#x73;&#x75;&#110;&#115;&#104;&#x31;&#x6e;&#51;&#x5f;&#x34;&#x6e;&#x64;&#x5f;&#x72;&#x34;&#x31;&#x6e;&#98;&#x30;&#x77;&#115;&#64;&#102;&#x6c;&#97;&#114;&#x65;&#x2d;&#x6f;&#110;&#x2e;&#x63;&#x6f;&#109;">&#x73;&#x75;&#110;&#115;&#104;&#x31;&#x6e;&#51;&#x5f;&#x34;&#x6e;&#x64;&#x5f;&#x72;&#x34;&#x31;&#x6e;&#98;&#x30;&#x77;&#115;&#64;&#102;&#x6c;&#97;&#114;&#x65;&#x2d;&#x6f;&#110;&#x2e;&#x63;&#x6f;&#109;</a>“
                    mà không đúng).</p>
                <p>Ta thử disassemble chuỗi “\x0F\x0B\x00\x00”</p>
                <p><img src="/images/flareon/10/7.png"></p>
                <p>ud2 (ud là viết tắt của undefine), khi gặp lệnh này, process cha sẽ raise <code>SIGILL</code>. Ta xem
                    tiếp ở process con 1:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"> <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == SIGILL )</span><br><span class="line">&#123;</span><br><span class="line">  v11 = <span class="built_in">strlen</span>(input_81A56C0);</span><br><span class="line">  SIMP_WriteProcessMemory(parrent_pid, (<span class="keyword">int</span>)input_81A56C0, (<span class="keyword">int</span> *)input_81A56C0, v11);</span><br><span class="line">  call_ptrace_dynamic(PTRACE_GETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;regs);</span><br><span class="line">  v35 = regs.esp;</span><br><span class="line">  <span class="keyword">if</span> ( call_ptrace_dynamic(PTRACE_POKEDATA, parrent_pid, regs.esp + <span class="number">4</span>, (<span class="keyword">int</span>)input_81A56C0) == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  regs.eip = (<span class="keyword">int</span>)sub_8048DCB;</span><br><span class="line">  call_ptrace_dynamic(PTRACE_SETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;regs);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy là khi process cha gặp <code>SIGILL</code>, process con 1 sẽ set eip = 0x8048DCB, ngoài ra còn
                    set tham số thứ nhất (tại esp + 4) thành input mà ta nhập vào. Tóm lại nó chuyển đã chuyển
                    <code>sub_8048CDB(input)</code> thành <code>sub_8048DCB(input)</code>. Ta thử xem hàm
                    <code>sub_8048DCB</code>:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">sub_8048DCB</span><span class="params">(<span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v9 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  argv = <span class="string">&quot;rm&quot;</span>;</span><br><span class="line">  v4 = <span class="string">&quot;-rf&quot;</span>;</span><br><span class="line">  v5 = <span class="string">&quot;--no-preserve-root&quot;</span>;</span><br><span class="line">  v6 = <span class="string">&quot;/&quot;</span>;</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  execve(s, &amp;argv, <span class="number">0</span>);</span><br><span class="line">  --v9;</span><br><span class="line">  v8 = -nice(<span class="number">165</span>);</span><br><span class="line">  init_buffer_804B495((<span class="keyword">int</span>)&amp;v2, v8);</span><br><span class="line">  sub_804BABC(&amp;v2, &amp;unk_81A50EC);</span><br><span class="line">  sub_804BABC(&amp;v2, &amp;unk_81A50F0);</span><br><span class="line">  sub_804BABC(&amp;v2, &amp;unk_81A50F4);</span><br><span class="line">  sub_804BABC(&amp;v2, &amp;unk_81A50F8);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(s, &amp;unk_81A50EC, <span class="number">0x10</span>u) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;unk_81A50EC, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    result = sub_8048F05(s + <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;unk_81A50EC, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở hàm này ta thấy có <code>execve</code> và <code>nice</code>. Đặc biệt là
                    <code>v8 = -nice(165)</code>, sau đó <code>v8</code> được dùng làm buffer (???). Bởi vì hàm
                    <code>nice</code> return 1 số nguyên rất nhỏ, không thể nào dùng làm địa chỉ buffer được, chắc chắn
                    là có gì đó không ổn với hàm <code>nice</code> này.
                </p>
                <p>Như đã giải thích ở trên thì mỗi khi gặp 1 <code>syscall</code>, process cha sẽ raise
                    <code>SIGTRAP</code>, syscall number nằm ở eax. Ở process con, nó xử lý <code>SIGTRAP</code> như
                    sau:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">v3 = <span class="number">322423550</span> * (regs.orig_eax ^ <span class="number">0xDEADBEEF</span>);</span><br><span class="line"><span class="comment">// ... truncated</span></span><br><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">0xE8135594</span> ) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="keyword">if</span> ( v3 == <span class="number">0x2499954E</span> ) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="comment">// ... a lot of cases ...</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p><code>nice</code> có syscall number là 0x22, khi đó v3 = 0x3DFC1166:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">case</span> <span class="number">0x3DFC1166</span>:</span><br><span class="line">    v8 = (<span class="keyword">char</span> *)get_XorEnc_Str_8056281(reg.ebx);<span class="comment">// 0x22 -&gt; nice</span></span><br><span class="line">    buf = v8;</span><br><span class="line">    v9 = <span class="built_in">strlen</span>(v8);</span><br><span class="line">    SIMP_WriteProcessMemory(parrent_pid, (<span class="keyword">int</span>)&amp;data_arr_81A52A0, (<span class="keyword">int</span> *)buf, v9 + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">free</span>(buf);</span><br><span class="line">    reg.eax = <span class="number">0</span>;</span><br><span class="line">    d_ptrace(PTRACE_SETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;reg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Như vậy, nó đã modify hàm <code>nice</code>, trả về 1 string tùy vào giá trị của ebx (ebx là tham số
                    của <code>nice</code>).</p>
                <p>Có rất nhiều chỗ bị modify như vậy, nên mình liệt kê tóm tắt ra bảng sau, bạn đọc có thể tự RE lại
                    những chỗ này:</p>
                <table>
                    <thead>
                        <tr>
                            <th align="center">orig_eax</th>
                            <th align="center">value of v3</th>
                            <th align="center">syscall name</th>
                            <th align="center">summary</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td align="center">0xD9</td>
                            <td align="center">0xE8135594</td>
                            <td align="center">pivot_root</td>
                            <td align="center">mov <strong>DWORD</strong> ptr [ebx], ecx</td>
                        </tr>
                        <tr>
                            <td align="center">0x36</td>
                            <td align="center">0x2499954E</td>
                            <td align="center">ioctl</td>
                            <td align="center">?????</td>
                        </tr>
                        <tr>
                            <td align="center">0x5C</td>
                            <td align="center">0x4A51739A</td>
                            <td align="center">truncate</td>
                            <td align="center"><strong>&lt;——————————————- magic here</strong></td>
                        </tr>
                        <tr>
                            <td align="center">0x4</td>
                            <td align="center">0x7E85DB2A</td>
                            <td align="center">write</td>
                            <td align="center">ghi buffer ra stdout</td>
                        </tr>
                        <tr>
                            <td align="center">0x22</td>
                            <td align="center">0x3DFC1166</td>
                            <td align="center">nice</td>
                            <td align="center">lấy string dựa vào ebx</td>
                        </tr>
                        <tr>
                            <td align="center">0xB</td>
                            <td align="center">0xF7FF4E38</td>
                            <td align="center">execve</td>
                            <td align="center">xóa ‘\n’ trong tham số đầu tiên</td>
                        </tr>
                        <tr>
                            <td align="center">0x7A</td>
                            <td align="center">0x9C7A9D6</td>
                            <td align="center">uname</td>
                            <td align="center">mov <strong>QWORD</strong> ptr [ebx], 0x9E3779B9C6EF3720</td>
                        </tr>
                        <tr>
                            <td align="center">0x60</td>
                            <td align="center">0x9678E7E2</td>
                            <td align="center">get_priority</td>
                            <td align="center">(dùng bởi nice)</td>
                        </tr>
                        <tr>
                            <td align="center">0x1</td>
                            <td align="center">0xB82D3C24</td>
                            <td align="center">exit</td>
                            <td align="center">thoát chương trình</td>
                        </tr>
                        <tr>
                            <td align="center">0x98</td>
                            <td align="center">0xC93DE012</td>
                            <td align="center">mlockall</td>
                            <td align="center">return __pop_count(*(QWORD*)ebx)</td>
                        </tr>
                        <tr>
                            <td align="center">0xF</td>
                            <td align="center">0xAB202240</td>
                            <td align="center">chmod</td>
                            <td align="center">xor, ror 1 vài con số ….</td>
                        </tr>
                        <tr>
                            <td align="center">0x61</td>
                            <td align="center">0x83411CE4</td>
                            <td align="center">set_priority</td>
                            <td align="center">(dùng bởi nice)</td>
                        </tr>
                        <tr>
                            <td align="center">0x3</td>
                            <td align="center">0x91BDA628</td>
                            <td align="center">read</td>
                            <td align="center">gọi fgets</td>
                        </tr>
                    </tbody>
                </table>
                <p>Hàm <code>truncate</code> có nhiều thứ hay ho và chúng ta sẽ quay lại sau. Bây giờ ta quay lại hàm
                    <code>sub_8048DCB</code> (mình đã rename 1 số thứ):
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">sub_8048DCB</span><span class="params">(<span class="keyword">char</span> *inp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">// ... truncated </span></span><br><span class="line">  len = <span class="built_in">strlen</span>(inp);</span><br><span class="line">  <span class="comment">// truncated ...</span></span><br><span class="line">  execve(inp, &amp;argv, <span class="number">0</span>);                        <span class="comment">// remove &#x27;\n&#x27; at the end</span></span><br><span class="line">  --len;</span><br><span class="line">  v8 = -nice(<span class="number">0xA5</span>);                             <span class="comment">// return a string</span></span><br><span class="line">  j_customAES_expand_key_804B495((<span class="keyword">int</span>)aes_ctx, v8);<span class="comment">//</span></span><br><span class="line">  custom_AES_enc_804BABC((BYTE *)aes_ctx, (BYTE *)&amp;unk_81A50EC);</span><br><span class="line">  custom_AES_enc_804BABC((BYTE *)aes_ctx, (BYTE *)&amp;unk_81A50F0);</span><br><span class="line">  custom_AES_enc_804BABC((BYTE *)aes_ctx, (BYTE *)&amp;unk_81A50F4);</span><br><span class="line">  custom_AES_enc_804BABC((BYTE *)aes_ctx, (BYTE *)&amp;unk_81A50F8);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(inp, &amp;unk_81A50EC, <span class="number">0x10</span>u) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;unk_81A50EC, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    result = sub_8048F05(inp + <span class="number">16</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;unk_81A50EC, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    result = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm trên nhận vào input của chúng ta, loại bỏ dấu “\n” ở cuối cùng. Sau đó nó lấy 1 đoạn string bằng
                    nice để làm key. Key này được dùng để AES decrypt 1 string khác.</p>
                <blockquote>
                    <p> Bạn đọc có thể RE thử hàm AES ở trên, nó đã bị sửa lại, block size chỉ còn 4 thay vì 16.</p>
                </blockquote>
                <p>Sau đó, nó so sánh đoạn string vừa decrypt được với input của chúng ta. Đến đây ta hook hàm
                    <code>memcmp</code> để xem nội dung của 2 tham số:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">memcmp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *s1, <span class="keyword">const</span> <span class="keyword">void</span> *s2, <span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> (*orig_memcmp)(<span class="keyword">const</span> <span class="keyword">void</span> *s1, <span class="keyword">const</span> <span class="keyword">void</span> *s2, <span class="keyword">size_t</span> n) = dlsym(RTLD_NEXT, <span class="string">&quot;memcmp&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> r = orig_memcmp(s1, s2, n);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] memcmp s1: \&quot;%s\&quot;, s2: \&quot;%s\&quot;\n&quot;</span>, s1, s2);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Và:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">...</span><br><span class="line">[+] memcmp s1: &quot;AAAAAA&quot;, s2: &quot;w3lc0mE_t0_Th3_l&quot;</span><br><span class="line">...</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy 16 ký tự đầu là “w3lc0mE_t0_Th3_l”. Bây giờ ta chạy lại chương trình với input
                    “w3lc0mE_t0_Th3_lAAAAAA”:</p>
                <p><img src="/images/flareon/10/8.png"></p>
                <p>Lần này vẫn là dòng chữ “sorry …” đó, nhưng khác với lần đầu.</p>
                <p>Ở lần đầu, khi ta nhập input “AAAAA” thì chương trình hiện ngay dòng đó luôn, còn nếu ta nhập
                    “w3lc0…” thì chương trình mất khoảng 1 vài phút mới hiện lên dòng chữ đó, chứng tỏ là input này có
                    gì đó làm cho chương trình đi theo flow khác.</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(inp, &amp;unk_81A50EC, <span class="number">0x10</span>u) )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;unk_81A50EC, <span class="number">0</span>, <span class="number">0x10</span>u);</span><br><span class="line">    result = sub_8048F05(inp + <span class="number">16</span>); <span class="comment">// &lt;---- go</span></span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Bây giờ ta phân tích hàm <code>sub_8048F05</code>, hàm này nhận tham số là
                    <code>&amp;input[16]</code>:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">sub_8048F05</span><span class="params">(<span class="keyword">void</span> *src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v1 = nice(<span class="number">0xA4</span>);</span><br><span class="line">  s = (<span class="keyword">char</span> *)-v1;</span><br><span class="line">  v2 = <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)-v1);</span><br><span class="line">  v6 = calc_hash(<span class="number">0L</span>L, (<span class="keyword">int</span>)s, v2); <span class="comment">// v6 = 0x674a1dea4b695809</span></span><br><span class="line">  v5 = <span class="number">40000</span>;</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;file, src, <span class="number">0x20</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5; i += <span class="number">8</span> )</span><br><span class="line">    sub_804C369(&amp;file + i, v6, HIDWORD(v6), &amp;v4); <span class="comment">// decrypt ?</span></span><br><span class="line">  <span class="keyword">return</span> truncate(&amp;file, <span class="number">32</span>) == <span class="number">32</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta phân tích tiếp hàm <code>sub_804C369</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> __cdecl <span class="title">sub_804C369</span><span class="params">(<span class="keyword">__mode_t</span> *a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">const</span> <span class="keyword">char</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  sub_804C217(__PAIR__(a3, a2), <span class="number">16</span>, (<span class="keyword">int</span>)a4); <span class="comment">// &lt;------- try RE this function</span></span><br><span class="line">  v7 = *a1;</span><br><span class="line">  mode = a1[<span class="number">1</span>];</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v9 = mode;</span><br><span class="line">  v10 = v7 ^ chmod(a4, mode);</span><br><span class="line">  v7 = mode;</span><br><span class="line">  mode = v10; </span><br><span class="line">  MEMORY[<span class="number">0</span>](&amp;loc_804C3C4, &amp;v5); <span class="comment">// &lt;----- here</span></span><br><span class="line">  *a1 = mode;</span><br><span class="line">  a1[<span class="number">1</span>] = v7;</span><br><span class="line">  <span class="keyword">return</span> __readgsdword(<span class="number">0x14</span>u) ^ v11;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở trên ta có thể thấy dòng <code>MEMORY[0](...)</code>, đoạn đó tương đương với đoạn asm sau:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">xor eax, eax</span><br><span class="line">call eax</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn này sẽ làm process raise <code>SIGSEGV</code>. Process con 1 xử lý đoạn này như sau:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0xFF00</span>) &gt;&gt; <span class="number">8</span> == SIGSEGV )</span><br><span class="line">&#123;</span><br><span class="line">  call_ptrace_dynamic(PTRACE_GETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;regs);</span><br><span class="line">  v34 = call_ptrace_dynamic(PTRACE_PEEKDATA, parrent_pid, regs.esp, <span class="number">0</span>);</span><br><span class="line">  v33 = call_ptrace_dynamic(PTRACE_PEEKDATA, parrent_pid, regs.esp + <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">  v32 = call_ptrace_dynamic(PTRACE_PEEKDATA, parrent_pid, regs.esp + <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">  v31 = call_ptrace_dynamic(PTRACE_PEEKDATA, parrent_pid, v32, <span class="number">0</span>) + <span class="number">1</span>;</span><br><span class="line">  regs.esp += <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v31 &gt; <span class="number">15</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    regs.eip = v34;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    regs.eip = v33;</span><br><span class="line">    call_ptrace_dynamic(PTRACE_POKEDATA, parrent_pid, v32, v31);</span><br><span class="line">    regs.esp += <span class="number">16</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  call_ptrace_dynamic(PTRACE_SETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;regs);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Với đoạn code trên, giả sử ta có 1 hàm <code>f(x,y)</code> với <code>f == NULL</code> (để tạo
                    <code>SIGSEGV</code>), thì:
                </p>
                <ul>
                    <li>Nếu <code>(*y)++ &gt;= 16</code> thì <code>return</code>.</li>
                    <li>Ngược lại: <code>set eip = x</code>.</li>
                    <li>Tóm lại cái hàm <code>f</code> này giúp chương trình lặp 16 lần mà không cần dùng
                        <code>for, while, ...</code>.
                    </li>
                </ul>
                <p>Quay lại hàm <code>sub_804C369</code>, hàm này dùng để encrypt 1 block data gồm 8 bytes. Hàm này sử
                    dụng vòng loop bằng <code>SIGSEGV</code> như giải thích ở trên, bao gồm 2 bước:</p>
                <ul>
                    <li>Expand key:</li>
                </ul>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">expand_key</span><span class="params">(<span class="keyword">uint64_t</span> key, <span class="keyword">uint32_t</span> *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> *_ctx = ctx;</span><br><span class="line">    <span class="keyword">uint64_t</span> k = key;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        _ctx[<span class="number">7</span>] = k &amp; <span class="number">0xFFFFFFFF</span>ull;</span><br><span class="line">        _ctx[<span class="number">19</span>] = (k &gt;&gt; <span class="number">32u</span>ll) &amp; <span class="number">0xFFFFFFFF</span>ull;</span><br><span class="line">        _ctx[<span class="number">41</span>] = pop_cnt(k) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">int</span> _v6 = k &amp; <span class="number">1</span>;</span><br><span class="line">        k = k &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (_v6)</span><br><span class="line">        &#123;</span><br><span class="line">            k = k ^ <span class="number">0x9E3779B9C6EF3720</span>uLL;</span><br><span class="line">        &#125;</span><br><span class="line">        _ctx = _ctx + <span class="number">62</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <ul>
                    <li>Encrypt:</li>
                </ul>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">uint32_t</span> <span class="title">encipher_8bytes</span><span class="params">(<span class="keyword">uint32_t</span> *a1, <span class="keyword">uint64_t</span> key, <span class="keyword">uint32_t</span> *ctx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> v7;</span><br><span class="line">    <span class="keyword">uint32_t</span> v8;</span><br><span class="line">    <span class="keyword">uint32_t</span> v10;</span><br><span class="line">    expand_key(key, ctx);</span><br><span class="line">    <span class="keyword">uint32_t</span> *_ctx = ctx;</span><br><span class="line">    <span class="keyword">uint64_t</span> k = key;</span><br><span class="line">    v7 = a1[<span class="number">0</span>];</span><br><span class="line">    v8 = a1[<span class="number">1</span>];</span><br><span class="line">    _ctx = ctx;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        v10 = v7 ^ ROR(v8 + _ctx[<span class="number">7</span>], _ctx[<span class="number">41</span>]) ^ _ctx[<span class="number">19</span>];</span><br><span class="line">        v7 = v8;</span><br><span class="line">        v8 = v10;</span><br><span class="line">        _ctx = _ctx + <span class="number">62</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    a1[<span class="number">0</span>] = v8;</span><br><span class="line">    a1[<span class="number">1</span>] = v7;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi encrypt đoạn input, nó encrypt luôn gần 40000 bytes data trong process cha, cuối cùng gọi
                    <code>truncate(data, 32)</code>.
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="built_in">memcpy</span>(&amp;file, src, <span class="number">0x20</span>u); <span class="comment">// src is actually &amp;input[16]</span></span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5; i += <span class="number">8</span> )</span><br><span class="line">  sub_804C369((<span class="keyword">__mode_t</span> *)(&amp;file + i), v6, SHIDWORD(v6), &amp;v4); <span class="comment">// encrypt_8bytes</span></span><br><span class="line"><span class="keyword">return</span> truncate(&amp;file, <span class="number">32</span>) == <span class="number">32</span>;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta lại tiếp tục coi process con 1 xử lý <code>truncate</code> như nào:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">case</span> <span class="number">0x4A51739A</span>: <span class="comment">// truncate (0x5C)</span></span><br><span class="line">    SIMP_ReadProcessMemory(parrent_pid, reg.ebx, (<span class="keyword">int</span> *)&amp;file, <span class="number">40000</span>);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">39999</span> &amp;&amp; *(_BYTE *)(i + <span class="number">0x804C640</span>); ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v18[i] = *(_BYTE *)(i + <span class="number">0x804C640</span>);<span class="comment">// file[i]</span></span><br><span class="line">      <span class="keyword">if</span> ( v46 == <span class="number">-1</span> &amp;&amp; v18[i] != *(_BYTE *)(i + <span class="number">0x81A5100</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        v46 = i;                <span class="comment">// v46 = incorrect position</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v46 = v44(<span class="number">0xA4F57126</span>, input_81A56C0, v46);</span><br><span class="line">    reg.eax = v46;</span><br><span class="line">    d_ptrace(PTRACE_SETREGS, parrent_pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;reg);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Nó sẽ copy data vừa được encrypt lên stack của chính nó, đồng thời so sánh data đó với 1 mảng
                    hardcode ở 0x81A5100, ở đây có 32 byte
                    <code>[100, 160, 96, 2, 234, 138, 135, 125, 108, 233, 124, 228, 130, 63, 45, 12, 140, 183, 181, 235, 207, 53, 79, 66, 79, 173, 43, 73, 32, 40, 124, 224]</code>.
                </p>
                <p>Ta viết ngay 1 đoạn decrypt đoạn trên:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ctx[<span class="number">62</span>*<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">uint8_t</span> data[] = &#123; <span class="number">100</span>, <span class="number">160</span>, <span class="number">96</span>, <span class="number">2</span>, <span class="number">234</span>, <span class="number">138</span>, <span class="number">135</span>, <span class="number">125</span>, <span class="number">108</span>, <span class="number">233</span>, <span class="number">124</span>, <span class="number">228</span>, <span class="number">130</span>, <span class="number">63</span>, <span class="number">45</span>, <span class="number">12</span>, <span class="number">140</span>, <span class="number">183</span>, <span class="number">181</span>, <span class="number">235</span>, <span class="number">207</span>, <span class="number">53</span>, <span class="number">79</span>, <span class="number">66</span>, <span class="number">79</span>, <span class="number">173</span>, <span class="number">43</span>, <span class="number">73</span>, <span class="number">32</span>, <span class="number">40</span>, <span class="number">124</span>, <span class="number">224</span> , <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">uint64_t</span> key = <span class="number">0x674a1dea4b695809</span>ULL;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i = i + <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        decipher_8bytes((<span class="keyword">uint32_t</span>*)(data + i), key, ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, (<span class="keyword">char</span>*)data);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">4nD_0f_De4th_4nd_d3strUct1oN_4nd</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Tiếp theo, nó gọi hàm <code>v44</code> tạo <code>SIGSEGV</code>:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">v46 = v44(<span class="number">0xA4F57126</span>, input_81A56C0, v46);</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta sẽ xem process con thứ 2 xử lý <code>SIGSEGV</code> như nào:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">if</span> ( _exitcode == SIGSEGV )             <span class="comment">// SIGSEGV</span></span><br><span class="line">    &#123;</span><br><span class="line">      d_ptrace(PTRACE_GETREGS, pid, <span class="number">0</span>, (<span class="keyword">int</span>)&amp;regs);</span><br><span class="line">      v_esp_0 = d_ptrace(PTRACE_PEEKDATA, pid, regs.esp, <span class="number">0</span>);</span><br><span class="line">      v_esp_4 = d_ptrace(PTRACE_PEEKDATA, pid, regs.esp + <span class="number">4</span>, <span class="number">0</span>);</span><br><span class="line">      v_esp_8 = d_ptrace(PTRACE_PEEKDATA, pid, regs.esp + <span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line">      v_esp_C = d_ptrace(PTRACE_PEEKDATA, pid, regs.esp + <span class="number">0xC</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="comment">// truncated ...</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">switch</span> ( v_esp_4 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> (<span class="keyword">int</span>)<span class="number">0xA4F57126</span>:</span><br><span class="line">            regs.eax = v_esp_C;</span><br><span class="line">            <span class="keyword">if</span> ( v_esp_C != <span class="number">-1</span> )            <span class="comment">// if (there is incorrect byte)</span></span><br><span class="line">            &#123;</span><br><span class="line">              SIMP_ReadProcessMemory(pid, v_esp_8, (<span class="keyword">int</span> *)input_81A56C0, <span class="number">62</span>);</span><br><span class="line">              <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(s1, <span class="string">&quot;@no-flare.com&quot;</span>, <span class="number">0xD</span>u) ) <span class="comment">// s1 is &amp;input[48];</span></span><br><span class="line">              &#123;</span><br><span class="line">                regs.eax = <span class="number">-1</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">		<span class="comment">// truncated ...</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">	<span class="comment">// truncated ... </span></span><br><span class="line">    &#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ơ, vậy <code>flag</code> là “<a
                        href="mailto:&#x77;&#x33;&#108;&#x63;&#48;&#x6d;&#x45;&#95;&#x74;&#48;&#x5f;&#84;&#104;&#51;&#95;&#x6c;&#x34;&#x6e;&#x44;&#x5f;&#x30;&#102;&#95;&#68;&#101;&#52;&#116;&#x68;&#95;&#x34;&#x6e;&#100;&#95;&#x64;&#x33;&#115;&#116;&#x72;&#85;&#x63;&#116;&#49;&#111;&#78;&#x5f;&#x34;&#x6e;&#x64;&#x40;&#110;&#111;&#45;&#x66;&#x6c;&#97;&#114;&#101;&#46;&#x63;&#111;&#x6d;">&#x77;&#x33;&#108;&#x63;&#48;&#x6d;&#x45;&#95;&#x74;&#48;&#x5f;&#84;&#104;&#51;&#95;&#x6c;&#x34;&#x6e;&#x44;&#x5f;&#x30;&#102;&#95;&#68;&#101;&#52;&#116;&#x68;&#95;&#x34;&#x6e;&#100;&#95;&#x64;&#x33;&#115;&#116;&#x72;&#85;&#x63;&#116;&#49;&#111;&#78;&#x5f;&#x34;&#x6e;&#x64;&#x40;&#110;&#111;&#45;&#x66;&#x6c;&#97;&#114;&#101;&#46;&#x63;&#111;&#x6d;</a>“
                    à, hmm có gì đó không ổn.</p>
                <p><img src="/images/flareon/10/9.png"></p>
                <p>Vậy là có gì đó không đúng, mình thử hook hàm <code>strncmp</code>, thì không thấy hàm
                    <code>strncmp</code> được thực thi. Như vậy là flow của chương trình đã bị đổi.
                </p>
                <p>Đoạn copy data lên stack có gì đó đáng nghi nên mình xem lại:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">39999</span> &amp;&amp; *(_BYTE *)(i + <span class="number">0x804C640</span>); ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v18[i] = *(_BYTE *)(i + <span class="number">0x804C640</span>);<span class="comment">// v18[i] = file[i]</span></span><br><span class="line">    <span class="comment">// truncated ...</span></span><br><span class="line">&#125;</span><br><span class="line">v46 = v44(<span class="number">0xA4F57126</span>, input_81A56C0, v46);</span><br><span class="line"><span class="comment">// truncated ...</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Trên stack, <code>v18</code> là một mảng char có độ dài 16000, nhưng đoạn trên có thể copy tới tận
                    40000 byte -&gt; BufferOverflow. Ta viết 1 đoạn code nhỏ để lấy đoạn data sau khi được encrypt:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> ctx[<span class="number">62</span>*<span class="number">17</span>];</span><br><span class="line">    <span class="keyword">uint64_t</span> key = <span class="number">0x674a1dea4b695809</span>ULL;</span><br><span class="line">    <span class="keyword">uint8_t</span>* data = <span class="keyword">new</span> <span class="keyword">uint8_t</span>[<span class="number">40000</span>];</span><br><span class="line">    FILE* f = fopen(<span class="string">&quot;dump.bin&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fread(data, <span class="number">1</span>, <span class="number">40000</span>, f);</span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">40000</span>; i = i + <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        encipher_8bytes((<span class="keyword">uint32_t</span>*)(data + i), key, ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    f = fopen(<span class="string">&quot;dec.bin&quot;</span>, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    fwrite(data, <span class="number">1</span>, <span class="number">40000</span>, f);</span><br><span class="line">    fclose(f);</span><br><span class="line">    <span class="keyword">delete</span>[] data;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở trong IDA, ta có thể tính được khoảng cách từ <code>v44</code> tới đầu mảng <code>v18</code> là
                    16164. Ta mở HxD để tới offset này:</p>
                <p><img src="/images/flareon/10/10.png"></p>
                <p>Vậy là <code>v44</code> đã bị ghi đè bởi 0x8053B70, địa chỉ này nằm trong đoạn data được encrypt, nên
                    ta sẽ: lấy đoạn data đã được encrypt để patch lên file break gốc, sau đó bỏ vào IDA để phân tích lại
                    hàm 0x8053B70.</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;break&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;dec.bin&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        patch_data = f.read()</span><br><span class="line">    data = data[:<span class="number">0x4640</span>] + patch_data + data[<span class="number">0x4640</span>+<span class="number">40000</span>:]</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;patch&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;[+] Done&#x27;</span>)</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi có file mới, ta dùng IDA phân tích tiếp hàm <code>sub_8053B70</code>, hàm này gọi lại hàm
                    <code>sub_805492E</code>(mình đã RE hàm này và rename lại hết, bạn đọc có thể tự RE lại các hàm liên
                    quan tới bigint và xác nhận lại):
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">void</span> __cdecl __noreturn <span class="title">sub_805492E</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> *inp, <span class="keyword">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// truncated ...</span></span><br><span class="line">  v_8053B70 = sub_8053B70;</span><br><span class="line">  pid = dword_81A5280;</span><br><span class="line">  ptrace_8054C5C(<span class="number">0</span>, dword_81A5280, PTRACE_GETREGS, &amp;regs);</span><br><span class="line">  <span class="keyword">if</span> ( a3 != <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    regs.eax = <span class="number">-1</span>;</span><br><span class="line">    ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_SETREGS, &amp;regs);</span><br><span class="line">    ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_DETACH, <span class="number">0</span>);</span><br><span class="line">    sysexit_80540CB(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  zeroing_80544E2(bi_input);</span><br><span class="line">  zeroing_80544E2(r32_byte);</span><br><span class="line">  zeroing_80544E2(v11);</span><br><span class="line">  hextoint_8054447(bi_1, (BYTE *)&amp;word_8055BE2[<span class="number">-67282078</span>] + (_DWORD)v_8053B70, <span class="number">64</span>);<span class="comment">// d1cc3447d5a9e1e6adae92faaea8770db1fab16b1568ea13c3715f2aeba9d84f (bi[1])</span></span><br><span class="line">  hextoint_8054447(bi_2, (BYTE *)&amp;dword_8055B60[<span class="number">-33641039</span>] + (_DWORD)v_8053B70, <span class="number">64</span>);<span class="comment">// c10357c7a53fa2f1ef4a5bf03a2d156039e7a57143000c8d8f45985aea41dd31 (bi[2])</span></span><br><span class="line">  hextoint_8054447(bi_3, (BYTE *)&amp;byte_8055B1F[<span class="number">-134564156</span> + (_DWORD)v_8053B70], <span class="number">64</span>);<span class="comment">// 480022d87d1823880d9e4ef56090b54001d343720dd77cbc5bc5692be948236c (bi[3])</span></span><br><span class="line">  hextoint_8054447(bi_4, (BYTE *)&amp;byte_8055B1F[<span class="number">-134564156</span> + (_DWORD)v_8053B70], <span class="number">64</span>);<span class="comment">// 480022d87d1823880d9e4ef56090b54001d343720dd77cbc5bc5692be948236c (bi[4])</span></span><br><span class="line">  hextoint_8054447(bi_5, (BYTE *)&amp;byte_8055BA1[<span class="number">-134564156</span> + (_DWORD)v_8053B70], <span class="number">64</span>);<span class="comment">// d036c5d4e7eda23afceffbad4e087a48762840ebb18e3d51e4146f48c04697eb (bi[5])</span></span><br><span class="line">  qmemcpy(bi_input, inp + <span class="number">48</span>, <span class="number">24u</span>);</span><br><span class="line">  fd = call_sysopen_805409F(<span class="number">0</span>, <span class="number">0</span>, (<span class="keyword">char</span> *)&amp;word_8055B12[<span class="number">-67282078</span>] + (_DWORD)v_8053B70);<span class="comment">// /dev/urandom</span></span><br><span class="line">  sysread_80540B5(<span class="number">0x20</span>u, r32_byte, fd);         <span class="comment">// read 32 byte /dev/urandom</span></span><br><span class="line">  divmod_80543CA(r32_byte, bi_1, placeholder, a4);<span class="comment">// divmod(r32, bi_1)</span></span><br><span class="line">  sysclose_8054091(fd);</span><br><span class="line">  assign_805422A(r32_byte, a4);                 <span class="comment">// r32 = a4</span></span><br><span class="line">  fast_pow_8054533(bi_2, r32_byte, (<span class="keyword">int</span>)bi_1, v11);</span><br><span class="line">  assign_805422A(r32_byte, a4);</span><br><span class="line">  fast_pow_8054533(bi_4, r32_byte, (<span class="keyword">int</span>)bi_1, v13);</span><br><span class="line">  mul_bigint_80546E1((<span class="keyword">int</span>)bi_input, (<span class="keyword">int</span>)v11, r32_byte);</span><br><span class="line">  divmod_80543CA(r32_byte, bi_1, placeholder, (BYTE *)v14);</span><br><span class="line">  <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="keyword">sizeof</span>(v17));</span><br><span class="line">  mb_cvt_int_to_hex_8054882(v13, v17, <span class="number">1024</span>);</span><br><span class="line">  <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="keyword">sizeof</span>(v17));</span><br><span class="line">  mb_cvt_int_to_hex_8054882(v14, v17, <span class="number">1024</span>);</span><br><span class="line">  <span class="keyword">if</span> ( cmp_big_int_8054251(bi_3, v13) || cmp_big_int_8054251(bi_5, v14) )<span class="comment">// v13 == bi_3 &amp;&amp; v14 == bi_5</span></span><br><span class="line">  &#123;</span><br><span class="line">    regs.eax = <span class="number">-1</span>;</span><br><span class="line">    ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_SETREGS, &amp;regs);</span><br><span class="line">    ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_DETACH, <span class="number">0</span>);</span><br><span class="line">    sysexit_80540CB(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  inp[<span class="number">72</span>] = <span class="number">0</span>;</span><br><span class="line">  ptrace_readdata_8054C75(pid, (<span class="keyword">char</span> *)dword_81A57C0, (<span class="keyword">void</span> **)inp, (<span class="keyword">signed</span> <span class="keyword">int</span>)&amp;v_8053B70, <span class="number">73</span>);</span><br><span class="line">  regs.eax = <span class="number">32</span>;</span><br><span class="line">  ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_SETREGS, &amp;regs);</span><br><span class="line">  ptrace_8054C5C(<span class="number">0</span>, pid, PTRACE_DETACH, <span class="number">0</span>);</span><br><span class="line">  sysexit_80540CB(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <blockquote>
                    <p><strong>Mẹo:</strong> bạn đọc có thể chỉ cần nhìn vào các tham số trước và sau khi thực hiện hàm
                        để đoán xem hàm đó làm gì, thay vì phải RE.</p>
                </blockquote>
                <p>Ta viết lại đoạn trên như sau:</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">r32 = rand();</span><br><span class="line">a4 = r32 % bi[<span class="number">1</span>];</span><br><span class="line">r32 = a4;</span><br><span class="line">bi[<span class="number">2</span>] = (bi[<span class="number">2</span>] ** r32) % (bi_1), v11 = old_bi[<span class="number">2</span>];</span><br><span class="line">r32 = a4;</span><br><span class="line">bi[<span class="number">4</span>] = (bi[<span class="number">4</span>] ** r32) % (bi_1), v13 = old_bi[<span class="number">4</span>];</span><br><span class="line">r32 = <span class="built_in">input</span> * v11;</span><br><span class="line">v14 = r32 % bi[<span class="number">1</span>];</span><br><span class="line">v14 == bi[<span class="number">5</span>]; &lt;---------- condition</span><br><span class="line">v14 = (<span class="built_in">input</span> * bi[<span class="number">2</span>]) % bi[<span class="number">1</span>];</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Về cơ bản hàm trên sẽ:</p>
                <ul>
                    <li>Chuyển <code>input[48:48+24]</code> sang số nguyên, little endian, ta gọi số này là
                        <code>x</code>.
                    </li>
                    <li>Ta phải giải <code>(x * bi[2]) % bi[1] == bi[5]</code></li>
                </ul>
                <p>Với phương trình <code>x * y = t (mod z)</code>, ta nhân cả 2 vế với nghịch đảo modun của
                    <code>y</code>, được: <code>x * y * y^(-1) = t * y^(-1)</code>
                </p>
                <blockquote>
                    <p>-&gt; <code>x = t * y^(-1)</code></p>
                </blockquote>
                <p>Đoạn code sau tính <code>x</code> trong phương trình trên:</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python 3</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">egcd</span>(<span class="params">a, b</span>):</span></span><br><span class="line">    <span class="keyword">if</span> a == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> (b, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        g, y, x = egcd(b % a, a)</span><br><span class="line">        <span class="keyword">return</span> (g, x - (b // a) * y, y)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modinv</span>(<span class="params">a, m</span>):</span></span><br><span class="line">    g, x, y = egcd(a, m)</span><br><span class="line">    <span class="keyword">if</span> g != <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;modular inverse does not exist&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> x % m</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    z = <span class="number">0xd1cc3447d5a9e1e6adae92faaea8770db1fab16b1568ea13c3715f2aeba9d84f</span></span><br><span class="line">    y = <span class="number">0xc10357c7a53fa2f1ef4a5bf03a2d156039e7a57143000c8d8f45985aea41dd31</span></span><br><span class="line">    t = <span class="number">0xd036c5d4e7eda23afceffbad4e087a48762840ebb18e3d51e4146f48c04697eb</span></span><br><span class="line">    </span><br><span class="line">    r = (((modinv(y, z) * t)))</span><br><span class="line">    <span class="comment">#print (hex(r))</span></span><br><span class="line">    g = r % z</span><br><span class="line">    <span class="comment">#print (hex(g))</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">24</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="built_in">chr</span>((g &gt;&gt; (<span class="number">8</span>*i)) &amp; <span class="number">0xFF</span>), end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;&#x27;</span>)</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">_n0_puppi3s@flare-on.com</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy ta có flag ^^!</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">w3lc0mE_t0_Th3_l4nD_0f_De4th_4nd_d3strUct1oN_4nd_n0_puppi3s@flare-on.com</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <h1 id="11-rabbithole"><a href="#11-rabbithole" class="headerlink" title="11 - rabbithole">11 -
                        rabbithole</a></h1>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">One of our endpoints was infected with a very dangerous, yet unknown malware strain that operates in a fileless manner. The malware is - without doubt - an APT that is the ingenious work of the Cyber Army of the Republic of Kazohinia.</span><br><span class="line"></span><br><span class="line">One of our experts said that it looks like they took an existing banking malware family, and modified it in a way that it can be used to collect and exfiltrate files from the hard drive.</span><br><span class="line"></span><br><span class="line">The malware started destroying the disk, but our forensic investigators were able to salvage ones of the files. Your task is to find out as much as you can about the behavior of this malware, and try to find out what was the data that it tried to steal before it started wiping all evidence from the computer.</span><br><span class="line"></span><br><span class="line">Good luck!</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p><img src="/images/flareon/11/1.png"></p>
                <p>Ở challenge này chúng ta có file NTUSER.DAT, file này chứa thông tin về <a target="_blank"
                        rel="noopener" href="https://www.howtogeek.com/401365/what-is-the-ntuser.dat-file/">Registry</a>
                    của một user.</p>
                <p>Giải nén và dùng <a target="_blank" rel="noopener"
                        href="https://ericzimmerman.github.io/#!index.md">Registry Explorer</a> để mở file NTUSER.dat
                    này lên:</p>
                <blockquote>
                    <p>Registry Explorer là một tool dùng để xem file registry NTUSER.dat dưới dạng cây.</p>
                </blockquote>
                <p><img src="/images/flareon/11/2.png"></p>
                <p>Nhiều mẫu malware sử dụng cmd để start “powershell”, ta tìm thử chuỗi này:</p>
                <p><img src="/images/flareon/11/3.png"></p>
                <p>Trong số result, ta thấy key “SOFTWARE\Microsoft\Windows\CurrentVersion\Group
                    Policy\Scripts\Logon\0\0” có chuỗi base64 nghi ngờ:</p>
                <ul>
                    <li>Script: <code>C:\Windows\System32\forfiles.exe</code></li>
                    <li>Parameters:
                        <code>/p C:\WINDOWS\system32 /s /c &quot;cmd /c @file -ec aQBlAHgAIAAoAGcAcAAgACcASABLAEMAVQA6AFwAUwBPAEYAVABXAEEAUgBFAFwAVABpAG0AZQByAHAAcgBvACcAKQAuAEQA&quot; /m p*ll.*e</code>
                    </li>
                </ul>
                <p>Đoạn registry key trên dùng pattern <code>p*ll.*e</code> để match (regex ?) “powershell.exe”, dùng để
                    tránh antivirus quét phải cụm từ “powershell”. Paramerter “-ec” dùng để chạy đoạn code đã được mã
                    hóa bằng base64, ta decode đoạn mã này:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">iex (gp &#39;HKCU:\SOFTWARE\Timerpro&#39;).D</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Trong powershell, <code>iex</code> dùng để gọi 1 script khác <a target="_blank" rel="noopener"
                        href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7">tham
                        khảo</a>.</p>
                <p>Ta đến “HKCU\SOFTWARE\Timerpro” để xem key này chứa những gì:</p>
                <p><img src="/images/flareon/11/4.png"></p>
                <p>Entry <code>D</code> chứa 1 đoạn code powershell khác. Ta copy đoạn này ra file mới cho dễ đọc:</p>
                <figure class="highlight powershell">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="variable">$jjw</span>=<span class="string">&quot;kcsukccudy&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hjmk</span></span>&#123;[<span class="type">System.Convert</span>]::FromBase64String(<span class="variable">$args</span>[<span class="number">0</span>]);&#125;;</span><br><span class="line">[<span class="built_in">byte</span>[]]<span class="variable">$rpl</span>=hjmk(<span class="string">&quot;a very long base64 string&quot;</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">geapmkxsiw</span></span>&#123;<span class="variable">$kjurpkot</span>=hjmk(<span class="variable">$args</span>[<span class="number">0</span>]);[<span class="type">System.Text.Encoding</span>]::ASCII.GetString(<span class="variable">$kjurpkot</span>);&#125;;<span class="built_in">iex</span>(geapmkxsiw(<span class="string">&quot;another base64 string&quot;</span>));<span class="built_in">iex</span>(geapmkxsiw(<span class="string">&quot;and another one&quot;</span>));</span><br><span class="line"></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi decode các đoạn string bị mã hoá trên, ta được:</p>
                <figure class="highlight powershell">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="variable">$rpl</span>=<span class="string">&quot;a lot of bytes ...&quot;</span></span><br><span class="line"><span class="variable">$cqltd</span>=<span class="string">&quot;</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern IntPtr GetCurrentThreadId();`n</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern IntPtr OpenThread(uint nopeyllax,uint itqxlvpc,IntPtr weo);`n</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern uint QueueUserAPC(IntPtr lxqi,IntPtr qlr,IntPtr tgomwjla);`n</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern void SleepEx(uint wnhtiygvc,uint igyv);&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$tselcfxhwo</span>=<span class="built_in">Add-Type</span> <span class="literal">-memberDefinition</span> <span class="variable">$cqltd</span> <span class="literal">-Name</span> <span class="string">&#x27;alw&#x27;</span> <span class="literal">-namespace</span> eluedve <span class="literal">-passthru</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$dryjmnpqj</span>=<span class="string">&quot;ffcx&quot;</span>;<span class="variable">$nayw</span>=<span class="string">&quot;</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern IntPtr GetCurrentProcess();`n</span></span><br><span class="line"><span class="string">[DllImport(`&quot;kernel32`&quot;)]`npublic static extern IntPtr VirtualAllocEx(IntPtr wasmhqfy,IntPtr htdgqhgpwai,uint uxn,uint mepgcpdbpc,uint xdjp);&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ywqphsrw</span>=<span class="built_in">Add-Type</span> <span class="literal">-memberDefinition</span> <span class="variable">$nayw</span> <span class="literal">-Name</span> <span class="string">&#x27;pqnvohlggf&#x27;</span> <span class="literal">-namespace</span> rmb <span class="literal">-passthru</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$jky</span>=<span class="string">&quot;epnc&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$kwhk</span>=<span class="variable">$tselcfxhwo::OpenThread</span>(<span class="number">16</span>,<span class="number">0</span>,<span class="variable">$tselcfxhwo::GetCurrentThreadId</span>());</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$yhibbqw</span>=<span class="variable">$ywqphsrw::VirtualAllocEx</span>(<span class="variable">$ywqphsrw::GetCurrentProcess</span>(),<span class="number">0</span>,<span class="variable">$rpl</span>.Length,<span class="number">12288</span>,<span class="number">64</span>))</span><br><span class="line">&#123;</span><br><span class="line"> [<span class="type">System.Runtime.InteropServices.Marshal</span>]::<span class="built_in">Copy</span>(<span class="variable">$rpl</span>,<span class="number">0</span>,<span class="variable">$yhibbqw</span>,<span class="variable">$rpl</span>.length);</span><br><span class="line"> <span class="keyword">if</span>(<span class="variable">$tselcfxhwo::QueueUserAPC</span>(<span class="variable">$yhibbqw</span>,<span class="variable">$kwhk</span>,<span class="variable">$yhibbqw</span>))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="variable">$tselcfxhwo::SleepEx</span>(<span class="number">5</span>,<span class="number">3</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn code trên thực hiện:</p>
                <ul>
                    <li>Copy data ở biến <code>$rpl</code> vào 1 buffer được tạo bởi <code>VirtualAlloc</code>.</li>
                    <li>Tạo 1 thread với <code>QueueUserAPC</code> với tham số <code>pfnAPC</code> là buffer vừa tạo ở
                        trên, chứng tỏ đoạn data này là 1 đoạn shellcode.</li>
                    <li>Sau đó nó đợi thread thực hiện xong bằng <code>SleepEx</code>.</li>
                </ul>
                <p>Ta cùng xem đoạn shellcode bằng HxD trước khi phân tích nó.</p>
                <p><img src="/images/flareon/11/5.png"></p>
                <p>Ta có thể thấy 2 bytes PE ở offset 0x10, nếu ta tiếp tục kéo xuống thì sẽ thấy rất nhiều byte 0x00,
                    cho tới offset 0x1000 thì ta lại thấy rất nhiều bytes random. Khả năng cao đây là file PE nhưng đã
                    bị phá huỷ mất DOS HEADER.</p>
                <p>5 bytes đầu của file này là <code>e9 f7 99 00 00</code>, disassemble ta được “jmp 0x99fc”, ta bỏ file
                    này vào IDA rồi tới offset 0x99FC để phân tích hàm này:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_99FC</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>i64;</span><br><span class="line">  pBase = a1;</span><br><span class="line">  v3 = <span class="number">0</span>i64;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  pLdrLoadDll = <span class="number">0</span>i64;</span><br><span class="line">  pLdrGetProcedureAddress = <span class="number">0</span>i64;</span><br><span class="line">  nt_base = *(_QWORD *)(**(_QWORD **)(*(_QWORD *)(*(_QWORD *)(__readgsqword(<span class="number">0x30</span>u) + <span class="number">0x60</span>) + <span class="number">0x18</span>i64) + <span class="number">0x10</span>i64)</span><br><span class="line">                      + <span class="number">0x30</span>i64) &amp; <span class="number">0xFFFFFFFFFFFFF000</span>ui64;</span><br><span class="line">  pFirstDataDirectory = (IMAGE_DATA_DIRECTORY *)*(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;unk_88</span><br><span class="line">                                                                + *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)&amp;unk_3C + nt_base)</span><br><span class="line">                                                                + nt_base);</span><br><span class="line">  <span class="keyword">if</span> ( !(_DWORD)pFirstDataDirectory )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">1</span>;</span><br><span class="line">  ex_entry_count = *(ULONG *)((<span class="keyword">char</span> *)&amp;pFirstDataDirectory[IMAGE_DIRECTORY_ENTRY_EXCEPTION].VirtualAddress + nt_base);</span><br><span class="line">  ex = nt_base + *(ULONG *)((<span class="keyword">char</span> *)&amp;pFirstDataDirectory[<span class="number">3</span>].Size + nt_base);</span><br><span class="line">  security_data = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(nt_base</span><br><span class="line">                                 + *(ULONG *)((<span class="keyword">char</span> *)&amp;pFirstDataDirectory[IMAGE_DIRECTORY_ENTRY_SECURITY].VirtualAddress</span><br><span class="line">                                            + nt_base));</span><br><span class="line">  <span class="keyword">for</span> ( i = (<span class="keyword">unsigned</span> __int16 *)(nt_base + *(ULONG *)((<span class="keyword">char</span> *)&amp;pFirstDataDirectory[<span class="number">4</span>].Size + nt_base)); ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    LODWORD(len) = <span class="number">0</span>;</span><br><span class="line">    v12 = (_BYTE *)(*security_data + nt_base + <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> ( *v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        len = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(len + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v12[len] );                       <span class="comment">// __inline_strlen</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( (_DWORD)len == 8 &amp;&amp; *(_DWORD *)v12 == &#x27;aoLr&#x27; )// LdrLoadDll</span><br><span class="line">      &#123;</span><br><span class="line">        v1 = nt_base + *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ex + <span class="number">4</span>i64 * *i);</span><br><span class="line">        pLdrLoadDll = (<span class="keyword">int</span> (__fastcall *)(_QWORD, _QWORD, __int16 *, __int64 *))(nt_base</span><br><span class="line">                                                                               + *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ex + <span class="number">4</span>i64 * *i));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_10:</span><br><span class="line">    if ( !v3 &amp;&amp; (_DWORD)len == 20 &amp;&amp; *(_DWORD *)v12 == &#x27;teGr&#x27; )// LdrGetProcedureAddress</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = nt_base + *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ex + <span class="number">4</span>i64 * *i);</span><br><span class="line">      pLdrGetProcedureAddress = (<span class="keyword">int</span> (__fastcall *)(__int64, __int16 *, _QWORD, <span class="keyword">char</span> *))(nt_base</span><br><span class="line">                                                                                       + *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(ex + <span class="number">4</span>i64 * *i));</span><br><span class="line">    &#125;</span><br><span class="line">    ++security_data;</span><br><span class="line">    <span class="keyword">if</span> ( !--ex_entry_count )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> v4;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">LABEL_17:</span><br><span class="line">  _pBase = (_DWORD *)(pBase &amp; <span class="number">0xFFFFFFFFFFFFF000</span>ui64);</span><br><span class="line">  *_pBase = <span class="number">0</span>;                                  <span class="comment">// ---------------------&gt; zeroing PE information</span></span><br><span class="line">  v14 = (IMAGE_NT_HEADERS64 *)((<span class="keyword">char</span> *)_pBase + (<span class="keyword">int</span>)_pBase[<span class="number">15</span>]);</span><br><span class="line">  import_RVA = v14-&gt;OptionalHeader.DataDirectory[<span class="number">1</span>].VirtualAddress;</span><br><span class="line">  <span class="keyword">if</span> ( !(_DWORD)import_RVA )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_63;</span><br><span class="line">  &#125;</span><br><span class="line">  v14-&gt;OptionalHeader.DataDirectory[<span class="number">1</span>].VirtualAddress = <span class="number">0</span>;<span class="comment">// --------------------&gt; zeroing PE information</span></span><br><span class="line">  v16 = (PIMAGE_IMPORT_DESCRIPTOR)((<span class="keyword">char</span> *)_pBase + import_RVA);</span><br><span class="line">  <span class="keyword">while</span> ( v16-&gt;Name )</span><br><span class="line">  &#123;</span><br><span class="line">    v17 = v16-&gt;Characteristics;</span><br><span class="line">    v18 = v16-&gt;FirstThunk;</span><br><span class="line">    <span class="keyword">if</span> ( v16-&gt;Characteristics || (v17 = v16-&gt;FirstThunk, (_DWORD)v18) )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = v17;</span><br><span class="line">      LODWORD(v20) = <span class="number">0</span>;</span><br><span class="line">      pNameDll = (<span class="keyword">char</span> *)_pBase + v16-&gt;Name;</span><br><span class="line">      v22 = (<span class="keyword">const</span> <span class="keyword">signed</span> __int64 *)((<span class="keyword">char</span> *)_pBase + v17);</span><br><span class="line">      v23 = *pNameDll;</span><br><span class="line">      <span class="keyword">if</span> ( *pNameDll )</span><br><span class="line">      &#123;</span><br><span class="line">        v24 = <span class="number">0</span>i64;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v20 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v20 + <span class="number">1</span>);</span><br><span class="line">          v45[v24] = v23;</span><br><span class="line">          v23 = pNameDll[v20];</span><br><span class="line">          v24 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)v20;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v23 );</span><br><span class="line">      &#125;</span><br><span class="line">      *pNameDll = <span class="number">0</span>;                            <span class="comment">// -----------------&gt; zeroing PE information</span></span><br><span class="line">      v42 = <span class="number">2</span> * v20;</span><br><span class="line">      v41 = <span class="number">2</span> * v20;</span><br><span class="line">      v43 = v45;</span><br><span class="line">      <span class="keyword">if</span> ( pLdrLoadDll(<span class="number">0</span>i64, <span class="number">0</span>i64, &amp;v41, &amp;v48) &lt; <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = <span class="number">126</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v25 = *v22;</span><br><span class="line">      <span class="keyword">if</span> ( *v22 )</span><br><span class="line">      &#123;</span><br><span class="line">        v26 = v18 - v19;</span><br><span class="line">        v44 = v18 - v19;</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v27 = <span class="number">0</span>;</span><br><span class="line">          v28 = <span class="number">0</span>i64;</span><br><span class="line">          <span class="keyword">if</span> ( _bittest64(v22, <span class="number">0x3F</span>u) )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( v25 &lt; (<span class="keyword">unsigned</span> __int64)_pBase || v25 &gt;= (<span class="keyword">unsigned</span> __int64)_pBase + v14-&gt;OptionalHeader.SizeOfImage )</span><br><span class="line">            &#123;</span><br><span class="line">              v27 = *(_WORD *)v22;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              v28 = (__int16 *)v25;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            v28 = (__int16 *)((<span class="keyword">char</span> *)_pBase + *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)v22);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            pNameDll = (<span class="keyword">char</span> *)(v28 + <span class="number">1</span>);</span><br><span class="line">            LODWORD(v29) = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( *((_BYTE *)v28 + <span class="number">2</span>) )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">              &#123;</span><br><span class="line">                v29 = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(v29 + <span class="number">1</span>);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( pNameDll[v29] );</span><br><span class="line">            &#125;</span><br><span class="line">            v43 = v28 + <span class="number">1</span>;</span><br><span class="line">            v42 = v29;</span><br><span class="line">            v41 = v29;</span><br><span class="line">            v28 = &amp;v41;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( pLdrGetProcedureAddress(v48, v28, v27, (<span class="keyword">char</span> *)v22 + v26) &lt; <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( v28 )</span><br><span class="line">          &#123;</span><br><span class="line">            *pNameDll = <span class="number">0</span>;                      <span class="comment">// -------------&gt; zeroing PE information</span></span><br><span class="line">          &#125;</span><br><span class="line">          v26 = v44;</span><br><span class="line">          ++v22;</span><br><span class="line">          v25 = *v22;</span><br><span class="line">          <span class="keyword">if</span> ( !*v22 )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_44;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        v4 = <span class="number">127</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_44:</span><br><span class="line">    ++v16;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_63:</span><br><span class="line">    v30 = v14-&gt;OptionalHeader.DataDirectory[<span class="number">5</span>].VirtualAddress;<span class="comment">// relocate</span></span><br><span class="line">    v31 = (_DWORD *)((<span class="keyword">char</span> *)_pBase + v14-&gt;OptionalHeader.AddressOfEntryPoint);</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)v30 )</span><br><span class="line">    &#123;</span><br><span class="line">      v32 = v14-&gt;OptionalHeader.DataDirectory[<span class="number">5</span>].Size;</span><br><span class="line">      v33 = (_DWORD *)((<span class="keyword">char</span> *)_pBase + v30);</span><br><span class="line">      delta = (ULONGLONG)_pBase - v14-&gt;OptionalHeader.ImageBase;</span><br><span class="line">      v14-&gt;OptionalHeader.ImageBase = (ULONGLONG)_pBase;</span><br><span class="line">      <span class="keyword">while</span> ( v32 &gt; <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v35 = v33[<span class="number">1</span>];</span><br><span class="line">        v36 = (<span class="keyword">char</span> *)_pBase + *v33;</span><br><span class="line">        nEntry = (<span class="keyword">unsigned</span> __int64)(v35 - <span class="number">8</span>) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="keyword">int</span>)v32 &gt;= (<span class="keyword">int</span>)v35 &amp;&amp; (_DWORD)nEntry )</span><br><span class="line">        &#123;</span><br><span class="line">          v38 = v33 + <span class="number">2</span>;</span><br><span class="line">          nEntry = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)nEntry;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (*v38 &amp; <span class="number">0xF000</span>) == <span class="number">0xA000</span>u )</span><br><span class="line">            &#123;</span><br><span class="line">              *(_QWORD *)&amp;v36[*v38 &amp; <span class="number">0xFFF</span>] += delta;</span><br><span class="line">            &#125;</span><br><span class="line">            ++v38;</span><br><span class="line">            --nEntry;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( nEntry );</span><br><span class="line">        &#125;</span><br><span class="line">        v39 = v33[<span class="number">1</span>];</span><br><span class="line">        v32 -= v39;</span><br><span class="line">        v33 = (<span class="keyword">unsigned</span> <span class="keyword">int</span> *)((<span class="keyword">char</span> *)v33 + v39);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !((<span class="keyword">unsigned</span> <span class="keyword">int</span> (__fastcall *)(_DWORD *, __int64, _QWORD))v31)( </span><br><span class="line">            _pBase,</span><br><span class="line">            <span class="number">1</span>i64,</span><br><span class="line">            *(_QWORD *)&amp;v14-&gt;FileHeader.PointerToSymbolTable) ) <span class="comment">// &lt;----- call DllMain ?</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v4;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn code trên sử dụng kỹ thuật Reflective load dll (ngoài ra sau khi load được dll lên bộ nhớ, nó
                    cũng zeroing một số phần data để gây khó khăn cho việc dump và phân tích). </p>
                <p>Để dễ dàng debug chương trình trên, mình thêm 1 dòng trước khi đoạn script thực hiện
                    <code>VirtualAlloc</code>:
                </p>
                <figure class="highlight powershell">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="built_in">Write-Host</span> <span class="literal">-Object</span> (<span class="string">&#x27;The key that was pressed was: &#123;0&#125;&#x27;</span> <span class="operator">-f</span> [<span class="type">System.Console</span>]::ReadKey().Key.ToString());</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Đoạn code trên sẽ đợi người dùng bấm 1 phím bất kỳ, như vậy ta sẽ có thời gian để attach debugger vào
                    “powershell.exe”.</p>
                <p>Ta tiến hành debug đoạn script powershell như sau:</p>
                <ul>
                    <li>
                        <p>Chạy đoạn script trên, chương trình sẽ đợi ta bấm gì đó từ bàn phím.</p>
                    </li>
                    <li>
                        <p>Dùng windbg, attach vào powershell.exe.</p>
                    </li>
                    <li>
                        <p>Viết 1 đoạn windbg script để thực hiện việc nhảy tới chỗ shellcode cho nhanh:</p>
                    </li>
                </ul>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.block</span><br><span class="line">&#123;</span><br><span class="line">  bp kernel32!QueueUserApcStub</span><br><span class="line">  g</span><br><span class="line">  bp @rcx</span><br><span class="line">  r $t0 &#x3D; @rcx</span><br><span class="line">  g</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <ul>
                    <li>
                        <p>Thực thi đoạn script trên bằng lệnh:
                            <code>$$&gt;a&lt;C:\Users\admin\Desktop\11_-_rabbithole\script.txt</code> (bạn đọc tự thay
                            đổi đường dẫn).
                        </p>
                    </li>
                    <li>
                        <p>Sau đó bấm phím bất kỳ trong powershell, khi đó ta sẽ dừng lại ở đây:</p>
                    </li>
                </ul>
                <p><img src="/images/flareon/11/6.png"></p>
                <blockquote>
                    <p><strong>Mẹo</strong>: dùng script khi phải làm những việc lặp đi lặp lại giúp tiết kiệm rất nhiều
                        thời gian.</p>
                </blockquote>
                <p>Để dump được file dll ra, ta sẽ:</p>
                <ul>
                    <li>Đặt breakpoint ngay trước khi nó kịp gọi <code>DllMain</code>.</li>
                    <li>Trong hàm <code>sub_99FC</code> có 1 số chỗ zeroing IAT, v.v …, ta sẽ patch những đoạn đó bằng
                        0x90 nop.</li>
                </ul>
                <p>Đoạn script sau sẽ làm cả 2 điều ở trên:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.block</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">bp kernel32!QueueUserApcStub</span><br><span class="line">g</span><br><span class="line">bp @rcx</span><br><span class="line">r $t0 &#x3D; @rcx</span><br><span class="line"></span><br><span class="line">eb @$t0+0x9B0E+0x00 0x90</span><br><span class="line">eb @$t0+0x9B0E+0x01 0x90</span><br><span class="line">eb @$t0+0x9B0E+0x02 0x90</span><br><span class="line">eb @$t0+0x9B26+0x00 0x90</span><br><span class="line">eb @$t0+0x9B26+0x01 0x90</span><br><span class="line">eb @$t0+0x9B26+0x02 0x90</span><br><span class="line">eb @$t0+0x9B26+0x03 0x90</span><br><span class="line">eb @$t0+0x9B26+0x04 0x90</span><br><span class="line">eb @$t0+0x9B26+0x05 0x90</span><br><span class="line">eb @$t0+0x9B26+0x06 0x90</span><br><span class="line">eb @$t0+0x9B83+0x00 0x90</span><br><span class="line">eb @$t0+0x9B83+0x01 0x90</span><br><span class="line">eb @$t0+0x9B83+0x02 0x90</span><br><span class="line">eb @$t0+0x9B83+0x03 0x90</span><br><span class="line">eb @$t0+0x9C52+0x00 0x90</span><br><span class="line">eb @$t0+0x9C52+0x01 0x90</span><br><span class="line">eb @$t0+0x9C52+0x02 0x90</span><br><span class="line">eb @$t0+0x9C52+0x03 0x90</span><br><span class="line"></span><br><span class="line">bp @$t0+0x9D1C</span><br><span class="line">g</span><br><span class="line">g</span><br><span class="line">bc *</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi chạy đoạn script trên, ta kiểm tra SizeOfImage trong IMAGE_NT_HEADERS để dump file này ra cho
                    chính xác:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">0:015&gt; dt -r nt!_IMAGE_NT_HEADERS64 @$t0</span><br><span class="line">ntdll!_IMAGE_NT_HEADERS64</span><br><span class="line">   +0x000 Signature        : 0x99f7e9</span><br><span class="line">   +0x004 FileHeader       : _IMAGE_FILE_HEADER</span><br><span class="line">      +0x000 Machine          : 0x3400</span><br><span class="line">      +0x002 NumberOfSections : 6</span><br><span class="line">      +0x004 TimeDateStamp    : 0x5e61316e</span><br><span class="line">      +0x008 PointerToSymbolTable : 0xbcb280df</span><br><span class="line">      +0x00c NumberOfSymbols  : 0x13b54550</span><br><span class="line">      +0x010 SizeOfOptionalHeader : 0xf0</span><br><span class="line">      +0x012 Characteristics  : 0x203c</span><br><span class="line">   +0x018 OptionalHeader   : _IMAGE_OPTIONAL_HEADER64</span><br><span class="line">      +0x000 Magic            : 0x28df</span><br><span class="line">      +0x002 MajorLinkerVersion : 0x7a &#39;z&#39;</span><br><span class="line">      +0x003 MinorLinkerVersion : 0x7f &#39;&#39;</span><br><span class="line">      +0x004 SizeOfCode       : 0xda00</span><br><span class="line">      +0x008 SizeOfInitializedData : 0x2e00</span><br><span class="line">      +0x00c SizeOfUninitializedData : 0</span><br><span class="line">      +0x010 AddressOfEntryPoint : 0x3e58</span><br><span class="line">      +0x014 BaseOfCode       : 0x1000</span><br><span class="line">      +0x018 ImageBase        : 0x0000019e&#96;76340000</span><br><span class="line">      +0x020 SectionAlignment : 0x1000</span><br><span class="line">      +0x024 FileAlignment    : 0</span><br><span class="line">      +0x028 MajorOperatingSystemVersion : 4</span><br><span class="line">      +0x02a MinorOperatingSystemVersion : 0</span><br><span class="line">      +0x02c MajorImageVersion : 0</span><br><span class="line">      +0x02e MinorImageVersion : 0</span><br><span class="line">      +0x030 MajorSubsystemVersion : 5</span><br><span class="line">      +0x032 MinorSubsystemVersion : 2</span><br><span class="line">      +0x034 Win32VersionValue : 0</span><br><span class="line">      +0x038 SizeOfImage      : 0x15000</span><br><span class="line">      +0x03c SizeOfHeaders    : 0x400</span><br><span class="line">      +0x040 CheckSum         : 0</span><br><span class="line">      +0x044 Subsystem        : 2</span><br><span class="line">      +0x046 DllCharacteristics : 0</span><br><span class="line">      +0x048 SizeOfStackReserve : 0x100000</span><br><span class="line">      +0x050 SizeOfStackCommit : 0x1000</span><br><span class="line">      +0x058 SizeOfHeapReserve : 0x100000</span><br><span class="line">      +0x060 SizeOfHeapCommit : 0x1000</span><br><span class="line">      +0x068 LoaderFlags      : 0</span><br><span class="line">      +0x06c NumberOfRvaAndSizes : 0x10</span><br><span class="line">      +0x070 DataDirectory    : [16] _IMAGE_DATA_DIRECTORY</span><br><span class="line">         +0x000 VirtualAddress   : 0x105a0</span><br><span class="line">         +0x004 Size             : 0x171</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>SizeOfImage là 0x15000, ta dump bằng lệnh sau:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.writemem C:\Users\admin\Desktop\11_-_rabbithole\dll2.dll @$t0 L15000</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Dùng PE-Bear để xem thông tin về file mới nhận được:</p>
                <p><img src="/images/flareon/11/7.png"></p>
                <p>Lý do lỗi là vì, file ta vừa nhận được cũng không hề có DOS HEADER. Ở đây mình sửa file như sau:</p>
                <ul>
                    <li>Copy phần DOS HEADER từ file khác insert vào đầu file này, pad bằng \x00 cho đủ 0x1000 bytes.
                    </li>
                    <li>Chỗ nào trong PE-header liên quan tới RVA, cộng thêm 0x1000 (Data Directory, EntryPoint, …).
                    </li>
                </ul>
                <p>File mới đã có thể được nhận dạng bởi PE-Bear:</p>
                <p><img src="/images/flareon/11/8.png"></p>
                <blockquote>
                    <p>Nếu bạn đọc làm lại bước này thì imagebase sẽ khác mình, tuy nhiên các offset sẽ vẫn giống.</p>
                </blockquote>
                <p>Ta phân tích file này bằng IDA:</p>
                <p><img src="/images/flareon/11/9.png"></p>
                <p>Tuy nhiên có nhiều chỗ hiện màu đỏ như trên, đó là vì bảng <code>IAT</code> bị sai. Bây giờ ta sửa
                    tiếp như sau, đầu tiên lấy offset con trỏ hàm 0x7FFAEF4D1B80:</p>
                <p><img src="/images/flareon/11/10.png"></p>
                <p>Vậy offset là 0x200C7380090 - imagebase - 0x1000 = 0xF090 , lý do trừ 0x1000 là vì ta đã thêm 0x1000
                    bytes vào làm DOS HEADER. Đến đây, ta dùng windbg để xem các symbol tại địa chỉ này:</p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">0:015&gt; dps @$t0+0xF090 L5</span><br><span class="line">00000283&#96;ab17f090  00007ff8&#96;6cd21b80 KERNEL32!CloseHandle</span><br><span class="line">00000283&#96;ab17f098  00007ff8&#96;6cd21d20 KERNEL32!SetEvent</span><br><span class="line">00000283&#96;ab17f0a0  00007ff8&#96;6cd1f850 KERNEL32!lstrcpyW</span><br><span class="line">00000283&#96;ab17f0a8  00007ff8&#96;6db60850 ntdll!RtlRemoveVectoredExceptionHandler</span><br><span class="line">00000283&#96;ab17f0b0  00007ff8&#96;6cd21c40 KERNEL32!CreateMutexW</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ta có thể thấy 0x7ff86cd21b80 chính là hàm <code>CloseHandle</code>. Ta copy hết kết quả trên ra file
                    khác, dùng đoạn script idapython sau để rename hết tên hàm:</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span>():</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;realfunc.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> i,line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f):</span><br><span class="line">            line = line.strip()</span><br><span class="line">            line = line.split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            addr = <span class="built_in">int</span>(line[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">if</span> addr == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            name = line[<span class="number">1</span>].replace(<span class="string">&#x27;!&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;Stub&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            set_name(<span class="number">0x200C7380000</span>+<span class="number">8</span>*i, name)</span><br><span class="line"><span class="comment"># realfunc.txt format:</span></span><br><span class="line"><span class="comment"># 00007ff86cd21b80 KERNEL32!CloseHandle</span></span><br><span class="line"><span class="comment"># ...</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi rename, ta đã có file ida dễ dàng phân tích hơn.</p>
                <p>Tiếp theo ta sử dụng gợi ý của đề bài: </p>
                <blockquote>
                    <p>One of our experts said that it looks like they took an existing banking malware family …</p>
                </blockquote>
                <p>Thông tin mà mình tìm được khi google:</p>
                <ul>
                    <li><a target="_blank" rel="noopener" href="https://github.com/t3rabyt3-zz/Gozi">source code gozi
                            malware</a>.</li>
                    <li><a target="_blank" rel="noopener"
                            href="https://www.fireeye.com/blog/threat-research/2020/01/saigon-mysterious-ursnif-fork.html">SAIGON,
                            the Mysterious Ursnif Fork</a></li>
                </ul>
                <p>Kết hợp với source code trên, ta có thể bỏ bớt một số hàm cần phải RE. Bây giờ ta phân tích tiếp hàm
                    <code>sub_200C7373E21C</code>:
                </p>
                <p><img src="/images/flareon/11/11.png"></p>
                <p>Hàm <code>sub_200C737E21C</code> sẽ trả về một chuỗi ngẫu nhiên, sau đó tạo một registry key với tên
                    này. Nó sử dụng xorshift64 để làm hàm random, với seed được tạo ra ở hàm
                    <code>sub_200C737D928</code> như sau:
                </p>
                <p><img src="/images/flareon/11/12.png"></p>
                <p>Seed sẽ dựa vào giá trị SID của user. Ở đây ta phải patch giá trị seed trên cho bằng đúng với giá trị
                    seed trên máy nạn nhân. Các công việc cần làm là:</p>
                <ul>
                    <li>Tìm SID của nạn nhân (tìm chuỗi “S-1-5-21” trong Registry Explorer, -&gt;
                        “S-1-5-21-3823548243-3100178540-2044283163”)</li>
                    <li>Patch memory SID bằng windbg khi chạy trên máy chúng ta bằng chuỗi SID vừa tìm ở trên.</li>
                    <li>Quan sát giá trị seed -&gt; 0x55707b4efb307bfa.</li>
                    <li>Các lần chạy sau đó không patch SID nữa mà patch seed luôn.</li>
                </ul>
                <p>Sau khi patch xong, debug (mình đã ngồi bấm step in, step out rất nhiều) và quan sát trong
                    <code>IDA</code> thì ta thấy:
                </p>
                <ul>
                    <li>Program này đọc registry key
                        “HKEY_CURRENT_USER\Software\Timerpro\Columncurrent\WebsoftwareProcesstemplate” và
                        “HKEY_CURRENT_USER\Software\Timerpro\Languagetheme\WebsoftwareProcesstemplate”.</li>
                    <li>Decrypt 2 giá trị trên bằng RSA (và Serpent).</li>
                    <li>Giải nén giá trị trên bằng ApLib.</li>
                    <li>Thực hiện inject 1 trong 2 giá trị trên vào explorer.exe. (Columncurrent cho x64, LanguageTheme
                        cho x86).</li>
                </ul>
                <p>Đến đây ta viết đoạn code để dump và decrypt các giá trị registry trên:</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python 3</span></span><br><span class="line"><span class="keyword">import</span> winreg</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump</span>(<span class="params">subkey_name: <span class="built_in">str</span></span>):</span></span><br><span class="line">    template = <span class="string">&#x27;Software\\Timerpro\\&#x27;</span></span><br><span class="line">    hKey = winreg.OpenKey(winreg.HKEY_CURRENT_USER, template + subkey_name)</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        os.mkdir(subkey_name)</span><br><span class="line">    <span class="keyword">except</span> OSError:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            s = winreg.EnumValue(hKey, i)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(subkey_name + <span class="string">&#x27;\\&#x27;</span> + s[<span class="number">0</span>], <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(s[<span class="number">1</span>])   </span><br><span class="line">            i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    winreg.CloseKey(hKey)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    dump(<span class="string">&#x27;Columncurrent&#x27;</span>)</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python 3</span></span><br><span class="line"><span class="keyword">import</span> serpent</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> binascii <span class="keyword">import</span> a2b_hex, b2a_hex</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublicRSAKey</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, e: <span class="built_in">int</span>, n:<span class="built_in">int</span></span>):</span></span><br><span class="line">        self.e = e</span><br><span class="line">        self.n = n</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span>(<span class="params">s: <span class="built_in">bytes</span></span>) -&gt; bytes:</span></span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(s).digest()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RSAPublicDecrypt</span>(<span class="params">m: <span class="built_in">int</span>, e: <span class="built_in">int</span>, n: <span class="built_in">int</span></span>) -&gt; int:</span></span><br><span class="line">    <span class="comment"># Calculate (m^e)%n</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pow</span>(m,e,n)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">unsign_data</span>(<span class="params">data: <span class="built_in">bytes</span>, key: PublicRSAKey</span>) -&gt; tuple:</span></span><br><span class="line">    <span class="comment"># return (True, data) if verify successfully</span></span><br><span class="line">    <span class="comment"># else return (False, )</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(data) &lt;= <span class="number">128</span>:</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">False</span>, )</span><br><span class="line">    ds = data[<span class="number">-128</span>:]</span><br><span class="line">    ds = <span class="built_in">int</span>.from_bytes(ds, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    p = RSAPublicDecrypt(ds, key.e, key.n)</span><br><span class="line">    p = p.to_bytes(<span class="number">128</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> p.startswith(<span class="string">b&#x27;\x00\x01&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">False</span>, )</span><br><span class="line">    i = <span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(p):</span><br><span class="line">        <span class="keyword">if</span> p[i] == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="built_in">len</span>(p):</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">False</span>, )</span><br><span class="line">    p = p[i + <span class="number">1</span>:]</span><br><span class="line">    signed_md5_hash = p[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">    serpent_key = p[<span class="number">16</span>:<span class="number">32</span>]</span><br><span class="line">    decrypted_size = <span class="built_in">int</span>.from_bytes(p[<span class="number">32</span>:<span class="number">36</span>], <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    decrypted_data = serpent.serpent_cbc_decrypt(serpent_key, data[:<span class="number">-128</span>], <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">16</span>)[:decrypted_size]</span><br><span class="line">    md5_hash = md5(decrypted_data)</span><br><span class="line">    <span class="keyword">if</span> signed_md5_hash == md5_hash:</span><br><span class="line">        <span class="keyword">return</span> (<span class="literal">True</span>, decrypted_data)</span><br><span class="line">    <span class="keyword">return</span> (<span class="literal">False</span>, )</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(argv) != <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;[+] python dec.py &lt;filename&gt;&#x27;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br><span class="line">    n = \</span><br><span class="line">    <span class="string">&quot;c3da263df172293373b0431e&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;e00bac4c3db723bee2d9ccc0a7ef8d03&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;68c33c577df7e64f09503437e9178533&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;c9f3b4d4eebd7fe1075e2e553939d43c&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;25eb8a89a5fd7ad5f8a52c20713ae878&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;cf2b1f322acfe8b7c55dad60b3520614&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;19fa713c903d9efc36baf95185880d03&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;ec165a51186cf1c323bc58c40b85fcbc&quot;</span>+\</span><br><span class="line">    <span class="string">&quot;7fa162ad&quot;</span></span><br><span class="line">    n = <span class="built_in">int</span>.from_bytes(a2b_hex(n), <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">    e = <span class="number">0x10001</span></span><br><span class="line">    rsa_key = PublicRSAKey(e, n)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(argv[<span class="number">1</span>], <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    res = unsign_data(data, rsa_key)</span><br><span class="line">    <span class="keyword">if</span> res[<span class="number">0</span>] == <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(argv[<span class="number">1</span>] + <span class="string">&#x27;.decrypt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(res[<span class="number">1</span>])</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;[+] Unsigned %s (%d bytes -&gt; %d bytes) !&#x27;</span> % (argv[<span class="number">1</span>], <span class="built_in">len</span>(data), <span class="built_in">len</span>(res[<span class="number">1</span>])))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&#x27;[+] Wrong signature !&#x27;</span>)</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python3</span></span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> argv</span><br><span class="line"><span class="keyword">import</span> aplib</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(argv[<span class="number">1</span>], <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    d = aplib.decompress(data[<span class="number">20</span>:], <span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(argv[<span class="number">1</span>] + <span class="string">&#x27;.decompressed&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(d)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;[+] %s: %d -&gt; %d bytes&#x27;</span> % (argv[<span class="number">1</span>], <span class="built_in">len</span>(data), <span class="built_in">len</span>(d)))</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Với 3 đoạn code trên, ta decrypt được rất nhiều file, trong đó có vài file bắt đầu bằng “PX” (và cũng
                    có file không decrypt được, có lẽ là vì những file đó không được encrypt theo cách này):</p>
                <p><img src="/images/flareon/11/13.png"></p>
                <p>File này sẽ được malware decode trước khi inject vào process. Ta dùng code ở <a target="_blank"
                        rel="noopener"
                        href="https://github.com/hasherezade/funky_malware_formats/tree/master/isfb_parser">bài này</a>
                    để decode file PX về dạng PE file rồi dùng IDA phân tích:</p>
                <p><img src="/images/flareon/11/14.png"></p>
                <p>Sau khi decode hết các file PX, ta có được rất nhiều file dll nhưng không biết chúng được load theo
                    thứ tự nào. Có quá nhiều file nên việc phân tích tĩnh rất khó khăn.</p>
                <p>Mình đã dành ra khoảng 10 ngày để phân tích tĩnh các file dll đó, nhưng vẫn không thấy được gì có ích
                    cho việc tìm flag. Vì sắp hết thời gian nên mình đã dừng việc phân tích tĩnh lại để tìm một hướng đi
                    khác.</p>
                <h1 id="Procmon-to-the-rescue"><a href="#Procmon-to-the-rescue" class="headerlink"
                        title="Procmon to the rescue">Procmon to the rescue</a></h1>
                <p>Đoán rằng các file .dll trên sẽ được inject vào explorer.exe, ta dùng procmon để theo dõi
                    explorer.exe (đừng quên patch seed):</p>
                <p><img src="/images/flareon/11/15.png"></p>
                <p>Chạy file powershell và quan sát:</p>
                <p><img src="/images/flareon/11/16.png"></p>
                <p>Ta thấy explorer đang cố gắng đọc hoặc ghi file gì đó ở “%appdata%\Microsoft\Oldsolution” và “%tmp%”.
                    Tiếp theo, ta thử ném vào trong thư mục “Oldsolution” 1 file bất kỳ và làm lại như trên:</p>
                <p><img src="/images/flareon/11/17.png"></p>
                <p><img src="/images/flareon/11/18.png"></p>
                <p>Lần này thì file chúng ta vừa tạo ra đã được program access. (Và nếu ta quay lại Oldsolution để xem
                    thì file này cũng bị xoá luôn). Ta đến thư mục %tmp% để xem file B1FC.bin:</p>
                <p><img src="/images/flareon/11/19.png"></p>
                <p>File của chúng ta đã bị nén lại (zip) và ghi ra %tmp%\B1FC.bin. Ngoài ra trong procmon còn 1 chỗ nữa
                    thú vị:</p>
                <p><img src="/images/flareon/11/20.png"></p>
                <p>Nó ghi gì đó vào registry, length = 1607200, nếu ta coi lại size của file B1FC.bin:</p>
                <p><img src="/images/flareon/11/21.png"></p>
                <p>Ta có thể thấy gần bằng nhau, có thể đoán là file B1FC.bin đã được thêm padding, sau đó ghi lên
                    registry. Ta thử xem “HKCU\Software\Timerpro\DiMap” chứa gì:</p>
                <p><img src="/images/flareon/11/22.png"></p>
                <p>Vậy là file này còn bị mã hoá trước khi ghi vào registry. Biết được rằng file sẽ bị mã hoá rồi sau đó
                    được ghi lên registry, ta có thể làm như sau:</p>
                <ul>
                    <li>Đặt breakpoint tại <code>ZwSetValueKey</code> (nếu bạn debug program này thì sẽ thấy nó xài rất
                        nhiều hàm <code>Zw</code>, đó là lý do mình không đặt breakpoint tại <code>RegSetValueExA</code>
                        và các hàm tương tự …)</li>
                    <li>Khi dừng lại tại breakpoint này ta kiểm tra xem key name có phải là “DiMap” không, nếu không thì
                        continue.</li>
                    <li>Nếu là “DiMap”, ta bắt đầu quan sát stack trace, sau 1 vài stack call thì thấy hàm
                        <code>sub_180001000</code> của “WebmodeThemearchive.dll” dùng để mã hoá file zip.
                    </li>
                </ul>
                <p><img src="/images/flareon/11/23.png"></p>
                <p>Nó sẽ gọi hàm export có ordinal 27 của 8576b0d0.dll (file này thực ra là
                    WebsoftwareProcesstemplate.dll), mà hàm 27 lại gọi hàm sau:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function">__int64 __fastcall <span class="title">DE_EN_serpent256</span><span class="params">(__int64 dataIn, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2, __int64 *pDataOut, <span class="keyword">unsigned</span> <span class="keyword">int</span> *pLenInAndOut, __int64 key16_byte, <span class="keyword">int</span> isEncrypt)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// [COLLAPSED LOCAL DECLARATIONS. PRESS KEYPAD CTRL-&quot;+&quot; TO EXPAND]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>i64;</span><br><span class="line">  _a4 = pLenInAndOut;</span><br><span class="line">  _a3 = pDataOut;</span><br><span class="line">  _a2 = a2;</span><br><span class="line">  _a1 = dataIn;</span><br><span class="line">  v11 = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">if</span> ( isEncrypt )</span><br><span class="line">  &#123;</span><br><span class="line">    v12 = (a2 + <span class="number">15</span>) &amp; <span class="number">0xFFFFFFF0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( a2 != v12 )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = DbgHeapAlloc_0300(v12);</span><br><span class="line">      v6 = v13;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">      &#123;</span><br><span class="line">        j_ntdll_memset(v13, <span class="number">0</span>i64, v12);</span><br><span class="line">        j_nt_memcpy_558(v6, _a1, _a2);</span><br><span class="line">      &#125;</span><br><span class="line">      _a1 = v6;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v12 = a2 &amp; <span class="number">0xFFFFFFF0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( _a1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v14 = DbgHeapAlloc_0300(v12);</span><br><span class="line">    <span class="keyword">if</span> ( v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      mb_init_serpent_238C(&amp;ctx, key16_byte);</span><br><span class="line">      *_a3 = v14;</span><br><span class="line">      *_a4 = v12;</span><br><span class="line">      <span class="keyword">if</span> ( v12 &gt;&gt; <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v15 = v12 &gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( isEncrypt )</span><br><span class="line">          &#123;</span><br><span class="line">            mb_dec_serpent_4F8C(&amp;ctx, _a1, v14);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            mb_enc_serpent_8544(&amp;ctx, _a1, v14);</span><br><span class="line">          &#125;</span><br><span class="line">          _a1 += <span class="number">4</span>;</span><br><span class="line">          v14 += <span class="number">4</span>;</span><br><span class="line">          --v15;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v15 );</span><br><span class="line">      &#125;</span><br><span class="line">      v11 = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    DbgHeapFree_02F8(v6);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v11;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Vậy là data zip của chúng ta bị mã hoá bằng SERPENT. Sau đó, data bị mã hoá được đưa tiếp vào hàm
                    <code>sub_180004BB3</code>:
                </p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="function"><span class="keyword">void</span> __usercall <span class="title">sub_180004BB3</span><span class="params">(__int64 a1@&lt;r12&gt;)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rdi</span></span><br><span class="line">  __int64 (__fastcall *v2)(_QWORD); <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  v1 = *(a1 + <span class="number">24</span>);</span><br><span class="line">  v2 = d6306e08_57;</span><br><span class="line">  LOWORD(v2) = d6306e08_57 - <span class="number">0x454</span>;</span><br><span class="line">  (v2)(*(a1 + <span class="number">24</span>), *(a1 + <span class="number">40</span>), *(qword_180006070 + <span class="number">120</span>), <span class="number">0</span>i64);<span class="comment">// encrypt one more time</span></span><br><span class="line">  LOBYTE(v3) = <span class="number">3</span>;</span><br><span class="line">  LOWORD(v4) = <span class="number">32639</span>;</span><br><span class="line">  <span class="number">8576b</span>0d0_79(v4, v3, v1);</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Ở hình trên, d6306e08 là file WordlibSystemser.dll, hàm có số ordinal 57 nằm ở 0x1800028EC, vậy
                    <code>v2 = 0x1800028EC-0x454 = 0x180002498</code>:
                </p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">.text:0000000180002498                 public _43</span><br><span class="line">.text:0000000180002498 _43             proc near               ; DATA XREF: .rdata:off_18000F1F8↓o</span><br><span class="line">.text:0000000180002498                                         ; .pdata:00000001800110F0↓o</span><br><span class="line">.text:0000000180002498                 jmp     _43_0</span><br><span class="line">.text:0000000180002498 _43             endp</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Hàm này chính là hàm có ordinal <code>43</code>, ta tới hàm này:</p>
                <figure class="highlight c++">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="keyword">void</span> __fastcall <span class="number">43</span>_0(__int64 a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, <span class="keyword">int</span> a4)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// er10</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// er11</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line">  _DWORD *v8; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// er8</span></span><br><span class="line">  <span class="keyword">char</span> v10; <span class="comment">// cl</span></span><br><span class="line">  <span class="keyword">bool</span> v11; <span class="comment">// zf</span></span><br><span class="line"></span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = a2 &gt;&gt; <span class="number">2</span>;</span><br><span class="line">  v7 = a3;</span><br><span class="line">  <span class="keyword">if</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = (_DWORD *)(a1 + <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v9 = *(v8 - <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">if</span> ( a4 &amp;&amp; !v9 &amp;&amp; v6 &gt; <span class="number">3</span> &amp;&amp; !*(v8 - <span class="number">1</span>) &amp;&amp; !*v8 &amp;&amp; !v8[<span class="number">1</span>] )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v10 = v5;</span><br><span class="line">      ++v8;</span><br><span class="line">      v5 ^= <span class="number">1u</span>;</span><br><span class="line">      v4 ^= v7 ^ __ROR4__(v9, <span class="number">4</span> * v10);</span><br><span class="line">      v11 = v6-- == <span class="number">1</span>;</span><br><span class="line">      *(v8 - <span class="number">3</span>) = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v11 );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Tóm lại: data zip của chúng ta sẽ bị mã hoá 2 lần trước khi ghi vào registry</p>
                <ul>
                    <li>Lần đầu là mã hoá Serpent (quan sát trong debugger, key là “GSPyrv3C79ZbR0k1”).</li>
                    <li>Lần sau là một đoạn custom crypto không quá khó (quan sát trong debugger, key luôn là
                        0xFB307BFA, nhưng phải patch đúng seed).</li>
                </ul>
                <p>Giờ ta viết đoạn mã decrypt là xong:</p>
                <figure class="highlight python">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment"># python3</span></span><br><span class="line"><span class="keyword">import</span> serpent</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rol32</span>(<span class="params">n: <span class="built_in">int</span>, i: <span class="built_in">int</span></span>) -&gt; int:</span></span><br><span class="line">    <span class="keyword">return</span> ((n &lt;&lt; i) &amp; <span class="number">0xFFFFFFFF</span>) | (n &gt;&gt; (<span class="number">32</span> - i))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt_base</span>(<span class="params">data: <span class="built_in">bytes</span>, key: <span class="built_in">int</span></span>):</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="number">0</span> &lt;= key &lt;= <span class="number">0xFFFFFFFF</span> <span class="comment"># 4 bytes key !</span></span><br><span class="line">    <span class="keyword">assert</span> <span class="built_in">len</span>(data) % <span class="number">4</span> == <span class="number">0</span> <span class="comment"># size must be aligned</span></span><br><span class="line">    n = <span class="built_in">len</span>(data) &gt;&gt; <span class="number">2</span></span><br><span class="line">    data = [<span class="built_in">int</span>.from_bytes(data[<span class="number">4</span>*i:<span class="number">4</span>*i+<span class="number">4</span>], <span class="string">&#x27;little&#x27;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n)]</span><br><span class="line">    data2 = [i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">            data2[i] = (key ^ data[i])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data2[i] = (key ^ data[i]) ^ data[i - <span class="number">1</span>]</span><br><span class="line">        data2[i] = rol32(data2[i], <span class="number">4</span>*(i % <span class="number">2</span>))</span><br><span class="line">    r = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> [<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]:</span><br><span class="line">            r.append((data2[i] &gt;&gt; (<span class="number">8</span>*j)) &amp; <span class="number">0xFF</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(r)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;DiMap&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    data = decrypt_base(data, <span class="number">0xFB307BFA</span>)</span><br><span class="line">    serpent_key = <span class="string">b&#x27;GSPyrv3C79ZbR0k1&#x27;</span></span><br><span class="line">    data = serpent.serpent_cbc_decrypt(serpent_key, data)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;out.zip&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data)</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&#x27;[+] Done!&#x27;</span>)</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

                <p>Sau khi chạy đoạn code trên ta được file zip mới, chứa flag:</p>
                <p><img src="/images/flareon/11/24.png"></p>
                <figure class="highlight plain">
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line">r4d1x_m4l0rum_357_cup1d1745@flare-on.com</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>

            </div>
        </article>




        <div id="footer-post-container">
            <div id="footer-post">

                <div id="nav-footer" style="display: none">
                    <ul>

                        <li><a href="/">home</a></li>

                        <li><a href="/about/">about</a></li>

                        <li><a href="/archives/">articles</a></li>

                        <li><a target="_blank" rel="noopener"
                                href="https://cyberjutsu.io/publications/">publications</a></li>

                    </ul>
                </div>

                <div id="toc-footer" style="display: none">
                    <ol class="toc">
                        <li class="toc-item toc-level-2"><a class="toc-link" href="#Phan-3"><span
                                    class="toc-number">1.</span> <span class="toc-text">Phần 3</span></a>
                            <ol class="toc-child">
                                <li class="toc-item toc-level-3"><a class="toc-link" href="#Final-thoughts"><span
                                            class="toc-number">1.1.</span> <span class="toc-text">Final
                                            thoughts</span></a></li>
                            </ol>
                        </li>
                    </ol>
                    </li>
                    <li class="toc-item toc-level-1"><a class="toc-link" href="#9-crackinstaller"><span
                                class="toc-number"></span> <span class="toc-text">9 - crackinstaller</span></a></li>
                    <li class="toc-item toc-level-1"><a class="toc-link" href="#10-break"><span
                                class="toc-number"></span> <span class="toc-text">10 - break</span></a></li>
                    <li class="toc-item toc-level-1"><a class="toc-link" href="#11-rabbithole"><span
                                class="toc-number"></span> <span class="toc-text">11 - rabbithole</span></a></li>
                    <li class="toc-item toc-level-1"><a class="toc-link" href="#Procmon-to-the-rescue"><span
                                class="toc-number"></span> <span class="toc-text">Procmon to the rescue</span></a>
                </div>

                <div id="share-footer" style="display: none">
                    <ul>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://www.facebook.com/sharer.php?u=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/"><i
                                    class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="https://twitter.com/share?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&text=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://www.linkedin.com/shareArticle?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="https://pinterest.com/pin/create/bookmarklet/?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&is_video=false&description=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon"
                                href="mailto:?subject=FLAREON 2020 - WRITEUP PHẦN 3&body=Check out this article: https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/"><i
                                    class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="https://getpocket.com/save?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://reddit.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://www.stumbleupon.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://digg.com/submit?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&title=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="http://www.tumblr.com/share/link?url=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&name=FLAREON 2020 - WRITEUP PHẦN 3&description="><i
                                    class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
                        <li><a class="icon" target="_blank" rel="noopener"
                                href="https://news.ycombinator.com/submitlink?u=https://blog.cyberjutsu.io/2021/01/06/flareon-phan-3/&t=FLAREON 2020 - WRITEUP PHẦN 3"><i
                                    class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
                    </ul>

                </div>

                <div id="actions-footer">
                    <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i
                            class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
                    <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i
                            class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
                    <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i
                            class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
                    <a id="top" style="display:none" class="icon" href="#"
                        onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg"
                            aria-hidden="true"></i> Top</a>
                </div>

            </div>
        </div>


        <footer id="footer">
            <div class="footer-left">
                Copyright &copy;


                2020-2021 -
                CyberJutsu Team
            </div>
            <div class="footer-right">
                <nav>
                    <ul>

                        <li><a href="/">home</a></li>

                        <li><a href="/about/">about</a></li>

                        <li><a href="/archives/">articles</a></li>

                        <li><a target="_blank" rel="noopener"
                                href="https://cyberjutsu.io/publications/">publications</a></li>

                    </ul>
                </nav>
            </div>
        </footer>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-50645715-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag() { dataLayer.push(arguments); }
            gtag('js', new Date());

            gtag('config', 'UA-50645715-1');
        </script>

    </div>
    <!-- styles -->

    <link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    <link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

    <script src="/lib/jquery/jquery.min.js"></script>


    <script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

    <!-- clipboard -->


    <script src="/lib/clipboard/clipboard.min.js"></script>

    <script type="text/javascript">
        $(function () {
            // copy-btn HTML
            var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
            btn += '<i class="far fa-clone"></i>';
            btn += '</span>';
            // mount it!
            $(".highlight table").before(btn);
            var clip = new ClipboardJS('.btn-copy', {
                text: function (trigger) {
                    return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str, it) => str + it.innerText + '\n', '')
                }
            });
            clip.on('success', function (e) {
                e.trigger.setAttribute('aria-label', "Copied!");
                e.clearSelection();
            })
        })
    </script>


    <script src="/js/main.js"></script>

    <!-- search -->

    <!-- Google Analytics -->

    <!-- Baidu Analytics -->

    <!-- Umami Analytics -->

    <!-- Disqus Comments -->


</body>

</html>